

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>J.U.S.T. Docker Functions &mdash; VSI Common 0.2.2+1dev documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="J.U.S.T. Entrypoint" href="just_entrypoint.auto.html" />
    <link rel="prev" title="Docker Functions" href="docker_functions.auto.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> VSI Common
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">J.U.S.T. Useful Simple Tasking</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../installation.html">J.U.S.T. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart_user.html">J.U.S.T. Quickstart Guide for Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html">Getting started developing with <code class="docutils literal notranslate"><span class="pre">just</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just.auto.html">J.U.S.T.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../files.html">J.U.S.T. Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just-tab.auto.html">Tab completion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_common.auto.html">Just Common Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_env.auto.html">Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_functions.auto.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_version.auto.html">Just Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_wrap.auto.html">J.U.S.T. Wrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../new_just.auto.html">New J.U.S.T.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../just_diff.auto.html">Updating a just environment</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">J.U.S.T. Plugins</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">J.U.S.T. Docker Plugin</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="docker_compose_override.auto.html">Docker Compose Override</a></li>
<li class="toctree-l4"><a class="reference internal" href="docker_functions.auto.html">Docker Functions</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">J.U.S.T. Docker Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="just_entrypoint.auto.html">J.U.S.T. Entrypoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="just_entrypoint_functions.auto.html">J.U.S.T. Entrypoint Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="just_entrypoint_user_functions.auto.html">J.U.S.T. Entrypoint User Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../singularity/index.html">J.U.S.T. Singularity Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../container_functions.auto.html">Container Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_bashcov_functions.auto.html">J.U.S.T. Bash Coverage Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_ci_functions.auto.html">J.U.S.T. CI Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_default_run_functions.auto.html">J.U.S.T. Default Run Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_git_functions.auto.html">J.U.S.T. Git Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_makeself_functions.auto.html">J.U.S.T. Makeself Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_robodoc_functions.auto.html">J.U.S.T. Robodoc Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_sphinx_functions.auto.html">J.U.S.T. Sphinx Docs Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../just_test_functions.auto.html">J.U.S.T. Test Functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../style.html">Contributing Style Guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VSI Common</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">J.U.S.T. Useful Simple Tasking</a> &raquo;</li>
        
          <li><a href="../index.html">J.U.S.T. Plugins</a> &raquo;</li>
        
          <li><a href="index.html">J.U.S.T. Docker Plugin</a> &raquo;</li>
        
      <li>J.U.S.T. Docker Functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/just/plugins/docker/just_docker_functions.auto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="j-u-s-t-docker-functions">
<h1>J.U.S.T. Docker Functions<a class="headerlink" href="#j-u-s-t-docker-functions" title="Permalink to this headline">¶</a></h1>
<dl class="bash file">
<dt id="file-just_docker_functions.bsh">
<code class="sig-name descname">just_docker_functions.bsh</code><a class="headerlink" href="#file-just_docker_functions.bsh" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="bash function">
<dt id="function-just_docker_functions.bsh docker-compose_restore_from_cache">
<code class="sig-name descname">docker-compose_restore_from_cache</code><a class="headerlink" href="#function-just_docker_functions.bsh docker-compose_restore_from_cache" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - Docker-compose filename</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$2</span></code> - Main service name to restore and rebuild. This needs to be the last (unnamed) stage</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[$3...]</span></code> - Addition services based on same dockerfile to restore and rebuild</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_CACHE_REPO</span></code> - Default value: <code class="docutils literal notranslate"><span class="pre">vsiri/ci_cache</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_PULL</span></code> - Pulls images to use. Default: 1 (true).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_BUILD</span></code> - Builds images after pulling cache. Default: 1 (true).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_PUSH</span></code> - Pushes images when done. Default: 1 (true).</p></li>
</ul>
</dd>
</dl>
<p>Restores image from cached images downloaded from the registry.</p>
<p>This is done in three steps:</p>
<ol class="arabic simple">
<li><p>First, the images are pulled from <code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_CACHE_REPO</span></code>, if available.</p></li>
<li><p>Next, the images are built against the Dockerfiles using the downloaded cache.</p></li>
<li><p>Lastly, the images are pushed back to <code class="docutils literal notranslate"><span class="pre">JUST_DOCKER_COMPOSE_CACHE_REPO</span></code> to keep them up to date.</p></li>
</ol>
<ul class="simple">
<li><p>Every stage is backed up as long as it is given a name. It must have a name because without one, it cannot be targeted using the <code class="docutils literal notranslate"><span class="pre">docker</span></code> cli or <code class="docutils literal notranslate"><span class="pre">docker-compose</span></code>. These stages are named: <code class="docutils literal notranslate"><span class="pre">${JUST_DOCKER_COMPOSE_CACHE_REPO}:${main_service_name}_${stage_name}</span></code></p></li>
<li><p>The final stage is tagged as: <code class="docutils literal notranslate"><span class="pre">${JUST_DOCKER_COMPOSE_CACHE_REPO}:final_${main_service_name}</span></code></p></li>
<li><p>Any VSI recipes used are also identified and tagged: <code class="docutils literal notranslate"><span class="pre">${JUST_DOCKER_COMPOSE_CACHE_REPO}:recipe_${main_service_name}_${recipe_name}</span></code>. The recipes contain “ONBUILD” commands that are different images than the <code class="docutils literal notranslate"><span class="pre">${JUST_DOCKER_COMPOSE_CACHE_REPO}:${main_service_name}_${stage_name}</span></code> version of them.</p></li>
</ul>
<p>Even though all the stages are restored, only the services specified (<code class="docutils literal notranslate"><span class="pre">$2</span></code> …) are retagged so that they can be used. If you need more than one service’s images restored, you will need to specify them all. If multiple services use the same image tag, they do not need to be specified. For example, service <code class="docutils literal notranslate"><span class="pre">foo</span></code> uses image <code class="docutils literal notranslate"><span class="pre">stuff:foo</span></code>, service <code class="docutils literal notranslate"><span class="pre">bar</span></code> uses image <code class="docutils literal notranslate"><span class="pre">stuff:bar</span></code>, and service <code class="docutils literal notranslate"><span class="pre">car</span></code> uses image <code class="docutils literal notranslate"><span class="pre">stuff:bar`,</span> <span class="pre">only</span> <span class="pre">services</span> <span class="pre">``foo</span></code> and <code class="docutils literal notranslate"><span class="pre">bar</span></code> need to be passed in.</p>
<dl class="bash function">
<dt id="function-just_docker_functions.bsh get_docker_recipes">
<code class="sig-name descname">get_docker_recipes</code><a class="headerlink" href="#function-just_docker_functions.bsh get_docker_recipes" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1...</span></code> - Dockerfiles to search for recipes</p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">JUST_RECIPE_REPO</span></code> - Name of recipe image to look for. Default: <code class="docutils literal notranslate"><span class="pre">vsiri/recipe</span></code></p>
</dd>
<dt class="field-odd">Output</dt>
<dd class="field-odd"><p><strong>stdout</strong> - Newline separated list of the tags of the recipes</p>
</dd>
</dl>
<p>Looks for recipes that are used in the Dockerfiles.</p>
<dl class="bash function">
<dt id="function-just_docker_functions.bsh docker_defaultify">
<code class="sig-name descname">docker_defaultify</code><a class="headerlink" href="#function-just_docker_functions.bsh docker_defaultify" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="bash command">
<dt id="command-just_docker_functions.bsh docker_defaultify build_recipes">
<code class="sig-prename descclassname">just build recipes</code><a class="headerlink" href="#command-just_docker_functions.bsh docker_defaultify build_recipes" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p>[<code class="docutils literal notranslate"><span class="pre">$1</span></code>]… - Recipe names to run</p>
</dd>
</dl>
<p>Runs <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">build</span></code> for the docker recipes. Useful command to call before <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> on your own project that uses recipes in vsi_common, to keep them synced with your build.</p>
<dl class="bash command">
<dt id="command-just_docker_functions.bsh docker_defaultify build_recipes-auto">
<code class="sig-prename descclassname">just build recipes-auto</code><a class="headerlink" href="#command-just_docker_functions.bsh docker_defaultify build_recipes-auto" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code>… - Dockerfiles to parse</p>
</dd>
</dl>
<p>Scans Dockerfiles for <code class="docutils literal notranslate"><span class="pre">vsiri/recipe:</span></code> images, and calls <a class="reference internal" href="#command-just_docker_functions.bsh docker_defaultify build_recipes"><code class="xref bash bash-cmd docutils literal notranslate"><span class="pre">build_recipes</span></code></a> on the recipes discovered. Accepts multiple files and <code class="docutils literal notranslate"><span class="pre">-</span></code> for stdin</p>
<dl class="bash command">
<dt id="command-just_docker_functions.bsh docker_defaultify log">
<code class="sig-prename descclassname">just log</code><a class="headerlink" href="#command-just_docker_functions.bsh docker_defaultify log" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p>[<code class="docutils literal notranslate"><span class="pre">$1</span></code>]… - Service names</p>
</dd>
</dl>
<p>Show logs from all service containers. Optionally specify service names to only log specific containers.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Does not pick up containers that didn’t exist when starting <code class="docutils literal notranslate"><span class="pre">just</span></code> log</p>
</div>
<p>Override the log target in your <code class="docutils literal notranslate"><span class="pre">Justfile</span></code> and call <code class="docutils literal notranslate"><span class="pre">__docker-compose-log</span></code> if you need to set other parameters.</p>
<dl class="bash command">
<dt id="command-just_docker_functions.bsh docker_defaultify docker_clean">
<code class="sig-prename descclassname">just docker clean</code><a class="headerlink" href="#command-just_docker_functions.bsh docker_defaultify docker_clean" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - Volume to be removed</p>
</dd>
</dl>
<p>Runs <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">volume</span> <span class="pre">rm</span></code> on the specified volume. If the volume is in use, there are four strategies to handle this:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ask</span></code> - (default) Interactively asks you if you want to use the stop, delete, or error strategy.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stop</span></code> - Attempts to stop the containers with a 30 second timeout and then forcefully remove the current containers mounting the volume, without prompting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">delete</span></code> - Mounts the volume and deletes all of the files. May not work when a container is running a database, or the volume is modified by the entrypoint, e.g. by adding user permissions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code> - Errors out instead of cleaning the volume</p></li>
</ol>
<p>The action for a specific volume is specified by setting the label <code class="docutils literal notranslate"><span class="pre">com.vsi.just.clean_action</span></code>.</p>
<p>For example, in a <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">venv</span><span class="p">:</span>
    <span class="nt">labels</span><span class="p">:</span>
      <span class="nt">com.vsi.just.clean_action</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ask</span>
</pre></div>
</div>
<div class="section" id="delete">
<h2>delete<a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h2>
<p>In the case of the <code class="docutils literal notranslate"><span class="pre">delete</span></code> strategy, an optional label, <code class="docutils literal notranslate"><span class="pre">com.vsi.just.clean_setup</span></code>, can be specified to designate what just target to run to repopulate a volume. Typically this just target should run <code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">-c</span> <span class="pre">&quot;:&quot;</span></code> or similar. This allows the entrypoint or another command to properly setup the volume, and set permissions, etc…</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="just_entrypoint.auto.html" class="btn btn-neutral float-right" title="J.U.S.T. Entrypoint" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="docker_functions.auto.html" class="btn btn-neutral float-left" title="Docker Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Vision Systems, Inc

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>