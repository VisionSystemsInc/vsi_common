<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>J.U.S.T. Mirror to an Air-gapped Repository &mdash; VSI Common 0.2.2+1dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="J.U.S.T. Git Functions" href="just_git_functions.auto.html" />
    <link rel="prev" title="J.U.S.T. Default Run Functions" href="just_default_run_functions.auto.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VSI Common
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">J.U.S.T. Useful Simple Tasking</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installation.html">J.U.S.T. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart_user.html">J.U.S.T. Quickstart Guide for Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html">Getting started developing with <code class="docutils literal notranslate"><span class="pre">just</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../just.auto.html">J.U.S.T.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files.html">J.U.S.T. Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just-tab.auto.html">Tab completion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_common.auto.html">Just Common Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_env.auto.html">Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_functions.auto.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_version.auto.html">Just Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_wrap.auto.html">J.U.S.T. Wrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_just.auto.html">New J.U.S.T.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../just_diff.auto.html">Updating a just environment</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">J.U.S.T. Plugins</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="docker/index.html">J.U.S.T. Docker Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="singularity/index.html">J.U.S.T. Singularity Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="container_functions.auto.html">Container Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_bashcov_functions.auto.html">J.U.S.T. Bash Coverage Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_ci_functions.auto.html">J.U.S.T. CI Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_default_run_functions.auto.html">J.U.S.T. Default Run Functions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">J.U.S.T. Mirror to an Air-gapped Repository</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_git_functions.auto.html">J.U.S.T. Git Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_install_functions.auto.html">J.U.S.T. Install CI Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_makeself_functions.auto.html">J.U.S.T. Makeself Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_pip-tools_functions.auto.html">J.U.S.T. Pip-tools Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_pre-commit_functions.auto.html">J.U.S.T. Pre-commit Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_robodoc_functions.auto.html">J.U.S.T. Robodoc Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_sphinx_functions.auto.html">J.U.S.T. Sphinx Docs Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_test_functions.auto.html">J.U.S.T. Test Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="just_troubleshooter_functions.auto.html">J.U.S.T. Troubleshooter Functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/recipes/pip-8210.auto.html">pip 8210</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../style.html">Contributing Style Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VSI Common</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">J.U.S.T. Useful Simple Tasking</a></li>
          <li class="breadcrumb-item"><a href="index.html">J.U.S.T. Plugins</a></li>
      <li class="breadcrumb-item active">J.U.S.T. Mirror to an Air-gapped Repository</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/just/plugins/just_git_airgap_repo.auto.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="j-u-s-t-mirror-to-an-air-gapped-repository">
<h1>J.U.S.T. Mirror to an Air-gapped Repository<a class="headerlink" href="#j-u-s-t-mirror-to-an-air-gapped-repository" title="Permalink to this heading"></a></h1>
<dl class="bash file">
<dt class="sig sig-object bash" id="file-just_git_airgap_repo.bsh">
<span class="sig-name descname"><span class="pre">just_git_airgap_repo.bsh</span></span><a class="headerlink" href="#file-just_git_airgap_repo.bsh" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>While creating a git mirror is as simple as <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--mirror</span></code>, unfortunately this command does not support git submodules or git lfs. This plugin helps create and subsequently clone a mirror of a project with submodules and/or git lfs.</p>
<p class="rubric">Example</p>
<p>Assume we have a <code class="docutils literal notranslate"><span class="pre">just</span></code> project called project_A hosted at <code class="docutils literal notranslate"><span class="pre">https://git-server.com/projectA/project_A.git</span></code> and vsi_common is a submodule of it.</p>
<p>This repository is recursively cloned to /src; it looks like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>project_A/
<span class="w">  </span>.gitmodules
<span class="w">  </span>Justfile
<span class="w">  </span>setup.env
<span class="w">  </span>external/vsi_common/<span class="w">               </span><span class="c1"># submodule</span>
<span class="w">  </span>external/vsi_common/docker/recipes<span class="w"> </span><span class="c1"># sub-submodule</span>
</pre></div>
</div>
<p>Before this repository can be mirrored (which is not the same thing as a clone) and pushed to a new air-gapped git server, first, a little setup is necessary.</p>
<p>The need for this setup is due to a chicken-and-egg problem. <em>chicken</em>) If a developer tried to simply clone the mirrored repository in the air-gapped environment, the submodules would fail to update because their URLs cannot be reached in that environment. Instead, the submodules must first be re-configured; then, they can be updated (recursively). This is handled by the <code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> target. <em>egg</em>) However, this obviously cannot be called until the vsi_common submodule is itself initialized and updated.</p>
<p>To accomplish this, a small function, <a class="reference internal" href="../../linux/git_airgap_submodule_helper.auto.html#function-git_airgap_submodule_helper.bsh git_airgap_submodule_update"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_airgap_submodule_helper.bsh</span> <span class="pre">git_airgap_submodule_update</span></code></a>, is (orphan) committed to the air-gapped repository so that it is available for this task. As no <code class="docutils literal notranslate"><span class="pre">just</span></code> functions can be called yet, this function should be called in the file specified by <span class="target" id="index-0"></span><a class="reference internal" href="../just_common.auto.html#envvar-JUST_SETUP_SCRIPT"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">JUST_SETUP_SCRIPT</span></code></a> (typically called setup.env). For example, the setup.env script, which typically looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">JUST_SETUP_SCRIPT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">/external/vsi_common/env.bsh&quot;</span>
</pre></div>
</div>
<p>would become:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">JUST_SETUP_SCRIPT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">/external/vsi_common/env.bsh&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&#39;just&#39; could not be loaded. Trying to setup the repository as an&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;air-gapped repository&quot;</span>
<span class="w">  </span><span class="c1"># source the contents of repo_map.env (in a bash 3.2 compatible way)</span>
<span class="w">  </span><span class="nb">source</span><span class="w"> </span>/dev/stdin<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="k">$(</span>git<span class="w"> </span>show<span class="w"> </span>origin/__just_git_mirror_info_file:repo_map.env<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>:<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">declare</span><span class="w"> </span>-Fx<span class="w"> </span>git_airgap_submodule_update<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ERROR the vsi_common submodule could not be found!&quot;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span>git_airgap_submodule_update<span class="w"> </span>external/vsi_common
<span class="k">fi</span>
<span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">/external/vsi_common/env.bsh&quot;</span>
</pre></div>
</div>
<p>Also, as mentioned, the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> <code class="docutils literal notranslate"><span class="pre">just</span></code> target handles reconfiguring the submodules for the air-gapped environment. As such, it should be called in place of the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule-update</span></code> <code class="docutils literal notranslate"><span class="pre">just</span></code> target. For instance, if <code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">sync</span></code> calls <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule-update</span></code>, then in an air-gapped environment it should call <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> instead.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> does not update the submodules with the additional safety provided by <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule-update</span></code> (although it is no less safe than the corresponding git calls).</p>
</div>
<p>This repository is now setup and can be mirrored and pushed to a new air-gapped git server:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">git</span> <span class="pre">export-repo-guided</span></code> - This target asks a series of questions and then mirrors the repository and its submodules (recursively). For this example, when prompted, we will, “Create a new mirror from a remote’s URL”, and save the the mirrored repositories to the output directory, <code class="docutils literal notranslate"><span class="pre">{output_dir}</span></code>. In this case, because there is only a single remote, <code class="docutils literal notranslate"><span class="pre">origin</span></code>, and a single branch, <code class="docutils literal notranslate"><span class="pre">main</span></code>, they are chosen automatically.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The mirror is created from (the URL of) the remote—not directly from this clone itself.</p>
</div>
<ol class="arabic simple" start="2">
<li><p>Transfer the archive at <code class="docutils literal notranslate"><span class="pre">{output_dir}/transfer_{date}.tgz</span></code> to your destination.</p></li>
<li><p>On the destination, create a directory, e.g., <code class="docutils literal notranslate"><span class="pre">{transfer_dir}</span></code>, and move the archive into it</p></li>
<li><p>Extract the archive (the archive will extract directly into this directory)</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">{transfer_dir}</span></code>, edit <code class="docutils literal notranslate"><span class="pre">repo_map.env</span></code> and set the <a class="reference internal" href="#var-just_git_airgap_repo.bsh create_repo_map JUST_GIT_AIRGAP_MIRROR_URL"><code class="xref bash bash-var docutils literal notranslate"><span class="pre">just_git_airgap_repo.bsh</span> <span class="pre">create_repo_map</span> <span class="pre">JUST_GIT_AIRGAP_MIRROR_URL</span></code></a> environment variable. For example,</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">JUST_GIT_AIRGAP_MIRROR_URL=https://git-airgap.com/projectA</span></code></p></li>
</ul>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>Initialize bare repositories on the air-gapped git server for project_A and its submodules. The list of all submodules can be found in the <code class="docutils literal notranslate"><span class="pre">repo_map.env</span></code> file, which maps between the submodule’s path and its new URL. In this example, these should be located at</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">https://git-airgap.com/projectA/project_A.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">https://git-airgap.com/projectA/vsi_common.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">https://git-airgap.com/projectA/recipes.git</span></code></p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Depending on your permission level and the git client on the air-gapped server, you may be allowed to create these repositories on demand when pushing them. This is, for example, possible with GitLab.</p>
</div>
<ol class="arabic simple" start="6">
<li><p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup.env</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">git</span> <span class="pre">import-repo</span></code> - Push the mirrored repository and all its submodules to the new git server as defined by repo_map.env</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You must have permissions on the server to (force) push to any branch; for example, in GitLab, no branches can be protected against the user doing the transfer.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A tag is left on all branches when they are transferred so if a branch is force pushed, the old branch can be recovered if necessary.</p>
</div>
<p>Subsequent updates can be pushed to the repositories using much the same process, although with a few variations:</p>
<ol class="arabic">
<li><p>In step 1, when prompted, choose “Base the archive off an existing airgap mirror”; in this example, <code class="docutils literal notranslate"><span class="pre">{output_dir}</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><p>In addition to another full archive, an incremental archive, <code class="docutils literal notranslate"><span class="pre">transfer_{date}_transfer_{previous_date}.tgz</span></code>, is also created (if supported). This incremental archive may be <em>significantly</em> smaller than the full archive.</p></li>
<li><dl class="simple">
<dt>If the incremental archive is transferred to the destination in step 2, then</dt><dd><ul>
<li><p>In step 3, move the archive into the same directory as before; in this example, <code class="docutils literal notranslate"><span class="pre">{transfer_dir}</span></code>.</p></li>
<li><p>In step 4, extract this incremental archive on top of the existing mirror.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>If instead the full archive is transferred in step 2, then</dt><dd><ul>
<li><p>In step 3, the archive can be moved into the same directory as before, <code class="docutils literal notranslate"><span class="pre">{transfer_dir}</span></code>, although it doesn’t have to be.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
<li><p>In step 5, unless there is a new submodule being mirrored, the repositories are already configured.</p></li>
</ol>
<p>A developer can then run:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://git-airgap.com/projectA/project_A.git</span></code> - Note: non-recursive</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup.env</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> - Clone submodules recursively from the new mirror</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a new submodule is added to the repository then <code class="docutils literal notranslate"><span class="pre">just</span> <span class="pre">git</span> <span class="pre">airgap-submodule-update</span></code> must be re-run instead of the standard git command, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code>, which will fail because the location of the submodules as defined in the .gitmodules file is not correct here—instead, the submodule must first be re-configured to point to the URL specified by repo_map.env. (This command is essentially doing a custom <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">sync</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code>. Accordingly, it must also be run if the URL of the submodule is changed, which could happen, e.g., if the location of the airgap’ed server changed. Note that in this case, an updated <code class="docutils literal notranslate"><span class="pre">repo_map.env</span></code> file would need to be committed to the old airgap’ed server.)</p>
<p>Limitations - There are a few limitations with a mirrored repository:</p>
<ol class="arabic simple">
<li><p>While the mirrored repository is a proper git repository, care must be taken to ensure subsequent (incremental) mirrors are successful: specifically, the transferred branches must remain read-only. However, additional branches/tags can be created as long as their names don’t clash with those from the host repository.</p></li>
<li><p><a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_mirror_main</span></code></a>, and by extension this plugin, does not mirror all submodules that have ever been part of the repo, only those from a specific branch/SHA/tag you specify (git’s init.defaultBranch by default). Consequently, checking out another version of the repository with a different version of the .gitmodules file in which a submodule has been deleted or renamed may cause the <code class="docutils literal notranslate"><span class="pre">git_airgap-submodule-update</span></code> to fail because the submodule’s remote URL could not be re-configured to point to the mirror.</p></li>
</ol>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_mirror_main</span></code></a>, <a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_push_main</span></code></a>, and <a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_clone_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_clone_main</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-just_git_airgap_repo.bsh create_repo_map">
<span class="sig-name descname"><span class="pre">create_repo_map</span></span><a class="headerlink" href="#function-just_git_airgap_repo.bsh create_repo_map" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Create the contents of the repo_map.env file</p>
<p>Create the repository mapping such that, once the <a class="reference internal" href="#var-just_git_airgap_repo.bsh create_repo_map JUST_GIT_AIRGAP_MIRROR_URL"><code class="xref bash bash-var docutils literal notranslate"><span class="pre">JUST_GIT_AIRGAP_MIRROR_URL</span></code></a> variable is defined, it can be sourced by <a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_push_main</span></code></a> and <a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_clone_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_clone_main</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Argument<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - The project’s repository name (e.g., vsi_common)</p>
</dd>
<dt class="field-even">Parameters<span class="colon">:</span></dt>
<dd class="field-even"><p>[<code class="docutils literal notranslate"><span class="pre">ASSOCIATIVE_REPO_MAP</span></code>] - Set to a value to create the repo map as an associative-array, <code class="docutils literal notranslate"><span class="pre">repos</span></code>, as opposed to two partitioned arrays (which is bash 3.2 compatible): <code class="docutils literal notranslate"><span class="pre">repo_urls</span></code> and <code class="docutils literal notranslate"><span class="pre">repo_paths</span></code>. (Default: unset; i.e., partitioned)</p>
</dd>
<dt class="field-odd">Output<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>stdout</em> - The contents of the repo_map.env file, the file that maps between the submodule’s path and its new URL. For example,</p>
</dd>
</dl>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># The urls are specified with the variable JUST_GIT_AIRGAP_MIRROR_URL,</span>
<span class="c1"># which must be set to the mirrored repositories&#39; new location on the</span>
<span class="c1"># air-gapped git server. Delay setting this variable until the archive has</span>
<span class="c1"># been moved to the destination in case the information must be controlled</span>
<span class="nv">JUST_GIT_AIRGAP_MIRROR_URL</span><span class="o">=</span>

<span class="nv">repo_paths</span><span class="o">=(</span>
<span class="w">  </span>./
<span class="w">  </span>./docker/recipes
<span class="o">)</span>
<span class="nv">repo_urls</span><span class="o">=(</span>
<span class="w">  </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">JUST_GIT_AIRGAP_MIRROR_URL</span><span class="si">}</span><span class="s2">/vsi_common.git&quot;</span>
<span class="w">  </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">JUST_GIT_AIRGAP_MIRROR_URL</span><span class="si">}</span><span class="s2">/recipes.git&quot;</span>
<span class="o">)</span>
</pre></div>
</div>
<p>If, for example, <a class="reference internal" href="#var-just_git_airgap_repo.bsh create_repo_map JUST_GIT_AIRGAP_MIRROR_URL"><code class="xref bash bash-var docutils literal notranslate"><span class="pre">JUST_GIT_AIRGAP_MIRROR_URL</span></code></a> was set to <code class="docutils literal notranslate"><span class="pre">https://git-server/projectA</span></code>, these urls would expand to:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">https://git-server/projectA/vsi_common.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">https://git-server/projectA/recipes.git</span></code></p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One limitation of this function occurs when two dependencies are only differentiated by their organization, e.g., projectC/dependency.git and projectD/dependency.git; then, these dependencies will both be mirrored to the same URL: “${JUST_GIT_AIRGAP_MIRROR_URL}/dependency.git”. One option is to override (or extend) this function to fixup the repository map as needed. Alternatively, if significant customization of the repository map is required, it can be created manually and used directly by <a class="reference internal" href="../../linux/git_mirror.auto.html#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">git_mirror_main</span></code></a> and family.</p>
</div>
<dl class="bash var">
<dt class="sig sig-object bash" id="var-just_git_airgap_repo.bsh create_repo_map JUST_GIT_AIRGAP_MIRROR_URL">
<span class="sig-name descname"><span class="pre">JUST_GIT_AIRGAP_MIRROR_URL</span></span><a class="headerlink" href="#var-just_git_airgap_repo.bsh create_repo_map JUST_GIT_AIRGAP_MIRROR_URL" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>A variable used in the repo_map.env file created by <a class="reference internal" href="#function-just_git_airgap_repo.bsh create_repo_map"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">create_repo_map</span></code></a> to specify the mirrored repositories’ new location on the air-gapped git server</p>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-just_git_airgap_repo.bsh orphan_commit_repo_map">
<span class="sig-name descname"><span class="pre">orphan_commit_repo_map</span></span><a class="headerlink" href="#function-just_git_airgap_repo.bsh orphan_commit_repo_map" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Orphan commit the repo_map.env file</p>
<p>Given a repository mapping like the one produced by <a class="reference internal" href="#function-just_git_airgap_repo.bsh create_repo_map"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">create_repo_map</span></code></a>, make an orphan commit in the repository (on a branch named __just_git_mirror_info_file by default) to a file named repo_map.env.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - The contents of the repo_map.env file; i.e., the file that maps between the submodule’s path and its new URL</p></li>
<li><p>[<code class="docutils literal notranslate"><span class="pre">$2</span></code>] - The name of the branch on which to make the orphan commit. Default: __just_git_mirror_info_file</p></li>
</ul>
</dd>
</dl>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-just_git_airgap_repo.bsh add_import-repo_just_project">
<span class="sig-name descname"><span class="pre">add_import-repo_just_project</span></span><a class="headerlink" href="#function-just_git_airgap_repo.bsh add_import-repo_just_project" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Create a simple just project in the prep_dir</p>
<p>This function creates a simple just project (a README.md, setup.env, and Justfile that includes this plugin) in the air-gapped mirror cache (the prep_dir) created by the <code class="docutils literal notranslate"><span class="pre">git_export-repo</span></code> <code class="docutils literal notranslate"><span class="pre">just</span></code> target. This just project can be used to push (aka import) the mirrored repositories to their respective air-gapped git server by using the <code class="docutils literal notranslate"><span class="pre">git_import-repo</span></code> <code class="docutils literal notranslate"><span class="pre">just</span></code> target.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - The output directory (prep_dir) that caches the mirrored repositories and archive to be transferred</p>
</dd>
<dt class="field-even">Output<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">${1}/{README.md,setup.env,Justfile}</span></code></p>
</dd>
</dl>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-just_git_airgap_repo.bsh relocate_git_defaultify">
<span class="sig-name descname"><span class="pre">relocate_git_defaultify</span></span><a class="headerlink" href="#function-just_git_airgap_repo.bsh relocate_git_defaultify" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Git relocate plugin for just</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="just_default_run_functions.auto.html" class="btn btn-neutral float-left" title="J.U.S.T. Default Run Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="just_git_functions.auto.html" class="btn btn-neutral float-right" title="J.U.S.T. Git Functions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Vision Systems, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>