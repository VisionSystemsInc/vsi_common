<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ci_load module &mdash; VSI Common 0.2.2+1dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="debug_readline module" href="debug_readline.html" />
    <link rel="prev" title="Pyhton Scripts" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VSI Common
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../just/index.html">J.U.S.T. Useful Simple Tasking</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Utilities</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../aliases.auto.html">Executable Aliases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ask_question.auto.html">Ask Question</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bash_utils.auto.html">Bash Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bin_utils.auto.html">Binary Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../check_shell.auto.html">Check Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../circular_source.auto.html">Circular source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../colors.auto.html">Colors Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../command_tools.auto.html">Command Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../common_source.auto.html">Common Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compat.auto.html">Compatibility Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compat_singularity.auto.html">Singularity Compatibility Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_info.auto.html">CUDA Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dir_tools.auto.html">Directory Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../elements.auto.html">Array Manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file_tools.auto.html">File Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../findin.auto.html">Find In</a></li>
<li class="toctree-l2"><a class="reference internal" href="../findinpaths.auto.html">Find In Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_airgap_submodule_helper.auto.html">Git Airgap Submodule Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_commit_description.auto.html">Git Commit Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_functions.auto.html">Git Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_mirror.auto.html">Git Mirror</a></li>
<li class="toctree-l2"><a class="reference internal" href="../group_names.auto.html">Group Names</a></li>
<li class="toctree-l2"><a class="reference internal" href="../inisin.auto.html">In Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isin.auto.html">Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linux_accounts.auto.html">Linux Accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lwhich.auto.html">Lwhich</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mount_tools.auto.html">Mount Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvidia_tools.auto.html">NVIDIA TOOLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parser.auto.html">Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pdbd.auto.html">PBDB - Primitive Bash Debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../picker.auto.html">Picker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pipenv_functions.auto.html">Pipenv Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../portable_patch.auto.html">Poratble Patch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postisin.auto.html">Postisin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preisin.auto.html">Preisin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../print_command.auto.html">Print Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_tools.auto.html">Python Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quotemire.auto.html">Quotemire</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random.auto.html">Random</a></li>
<li class="toctree-l2"><a class="reference internal" href="../real_path.auto.html">Real Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reisin.auto.html">Regular Expression Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="../requirements.auto.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../set_flags.auto.html">Set Flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../signal_tools.auto.html">String Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../source_once.auto.html">Source once</a></li>
<li class="toctree-l2"><a class="reference internal" href="../string_tools.auto.html">String Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../time_tools.auto.html">Time Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uwecho.auto.html">Unwrapping Echo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versions.auto.html">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../web_tools.auto.html">Web Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../yarp.auto.html">Yarp</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="modules.html">Pyhton Scripts</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">ci_load module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ci_load.CiLoad"><code class="docutils literal notranslate"><span class="pre">CiLoad</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ci_load.Popen2"><code class="docutils literal notranslate"><span class="pre">Popen2()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ci_load.stage_pattern"><code class="docutils literal notranslate"><span class="pre">stage_pattern</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="debug_readline.html">debug_readline module</a></li>
<li class="toctree-l3"><a class="reference internal" href="load_nvidia_uvm.html">load_nvidia_uvm module</a></li>
<li class="toctree-l3"><a class="reference internal" href="new_notebook.html">new_notebook module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../style.html">Contributing Style Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VSI Common</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Linux Utilities</a></li>
          <li class="breadcrumb-item"><a href="modules.html">Pyhton Scripts</a></li>
      <li class="breadcrumb-item active">ci_load module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/linux/python_scripts/ci_load.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-ci_load">
<span id="ci-load-module"></span><h1>ci_load module<a class="headerlink" href="#module-ci_load" title="Permalink to this heading"></a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="ci_load.CiLoad">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">ci_load.</span></span><span class="sig-name descname"><span class="pre">CiLoad</span></span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad" title="Permalink to this definition"></a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3.7/library/functions.html#object" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a></p>
<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.add_cache_from">
<span class="sig-name descname"><span class="pre">add_cache_from</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cf</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.add_cache_from"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.add_cache_from" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.build_stages">
<span class="sig-name descname"><span class="pre">build_stages</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.build_stages"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.build_stages" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.cache_image">
<span class="sig-name descname"><span class="pre">cache_image</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">extra_tags</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_loc</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.cache_image"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.cache_image" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.generate_push_pull_config">
<span class="sig-name descname"><span class="pre">generate_push_pull_config</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cache_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_loc</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.generate_push_pull_config"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.generate_push_pull_config" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.get_dockerfile">
<span class="sig-name descname"><span class="pre">get_dockerfile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">build</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.get_dockerfile"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.get_dockerfile" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.parse">
<span class="sig-name descname"><span class="pre">parse</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.parse"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.parse" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.pull_images">
<span class="sig-name descname"><span class="pre">pull_images</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.pull_images"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.pull_images" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.push_images">
<span class="sig-name descname"><span class="pre">push_images</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.push_images"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.push_images" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.restore_recipes">
<span class="sig-name descname"><span class="pre">restore_recipes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.restore_recipes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.restore_recipes" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.setup">
<span class="sig-name descname"><span class="pre">setup</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.setup"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.setup" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.setup_parser">
<span class="sig-name descname"><span class="pre">setup_parser</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.setup_parser"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.setup_parser" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.write_add_cache">
<span class="sig-name descname"><span class="pre">write_add_cache</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.write_add_cache"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.write_add_cache" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="ci_load.CiLoad.write_restore_recipe">
<span class="sig-name descname"><span class="pre">write_restore_recipe</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#CiLoad.write_restore_recipe"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.CiLoad.write_restore_recipe" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ci_load.Popen2">
<span class="sig-prename descclassname"><span class="pre">ci_load.</span></span><span class="sig-name descname"><span class="pre">Popen2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/ci_load.html#Popen2"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ci_load.Popen2" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="ci_load.stage_pattern">
<span class="sig-prename descclassname"><span class="pre">ci_load.</span></span><span class="sig-name descname"><span class="pre">stage_pattern</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'^</span> <span class="pre">*from</span> <span class="pre">+[a-zA-Z0-9:\\./_${}-]*</span> <span class="pre">+as</span> <span class="pre">+([^\\n]*)'</span></em><a class="headerlink" href="#ci_load.stage_pattern" title="Permalink to this definition"></a></dt>
<dd><p>## Explanation how this script works:</p>
<ol class="arabic simple">
<li><p>Parses the docker-compose file. The docker-compose file is fed through <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">config</span></code> so that all variables are substituted and anchors are expanded. This means that this needed to be run within <code class="docutils literal notranslate"><span class="pre">just</span></code> so that all environment variables are loaded.</p></li>
<li><p>A temporary “push pull” docker-compose yaml file is auto generated. This file will push and pull the cache from dockerhub (or whatever registry you decide to use)</p></li>
<li><p>The docker cache images are pulled</p></li>
<li><p>Another temporary docker-compose file is auto generated. This file is used to restore the recipes from the cache pulled, using cache-from. So if the image is pulled as “vsi-ri/cache:recipe_gosu” and the image name should be “vsi-ri/recipe:gosu”, it will let you build “vsi-ri/recipe:gosu” using “–cache-from = vsi-ri/cache:gosu”. Note: this is the ONBUILD recipes, not the gosu stage (recipe “instance”) that appears in your actual Dockerfile.</p></li>
<li><p>The recipes set up in step 3 are built</p></li>
<li><p>The recipes built in step 4 are re-tagged to their “cached” names, so that they are ready to be pushed at the end</p></li>
<li><p>A third docker-compose file is auto generated. The original docker-compose file is loaded, and a section for every single stage of the Dockerfile is copied based on the “main service” you specify. All of the possible “cache from” image names are added so that docker can build using the cache and the stages previously build. For example. If you build stage1 then stage2, stage2 shouldn’t rebuild stage1, it should cache-from stage1, etc…</p></li>
<li><p>Unfortunately docker-compose cannot be used to build a multistage dockerfile efficiently, it will rebuild every stage for unknown reasons. So the docker-compose file is parsed and docker calls are made to build the stages in order. Finally, the main service stage (the final stage) is built, at this point all the previous stages have been built and cached, so only the last stage is built.</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>The (optional) other services are tagged from the cached images just generated (based on the target stage names found in the docker-compose file), and then the main service image is tagged too. This way the image names have been restored so that they are ready for CI to use.</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple">
<li><p>Finally, that now updated images are push back to the registry</p></li>
</ol>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-left" title="Pyhton Scripts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debug_readline.html" class="btn btn-neutral float-right" title="debug_readline module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Vision Systems, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>