

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Git Mirror &mdash; VSI Common 0.2.2+1dev documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Group Names" href="group_names.auto.html" />
    <link rel="prev" title="Git Functions" href="git_functions.auto.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> VSI Common
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../just/index.html">J.U.S.T. Useful Simple Tasking</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Utilities</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="aliases.auto.html">Executable Aliases</a></li>
<li class="toctree-l2"><a class="reference internal" href="ask_question.auto.html">Ask Question</a></li>
<li class="toctree-l2"><a class="reference internal" href="bash_utils.auto.html">Bash Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="bin_utils.auto.html">Binary Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="check_shell.auto.html">Check Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="circular_source.auto.html">Circular source</a></li>
<li class="toctree-l2"><a class="reference internal" href="colors.auto.html">Colors Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="command_tools.auto.html">Command Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="common_source.auto.html">Common Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="compat.auto.html">Compatibility Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="compat_singularity.auto.html">Singularity Compatibility Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_info.auto.html">CUDA Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="dir_tools.auto.html">Directory Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="elements.auto.html">Array Manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_tools.auto.html">File Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="findin.auto.html">Find In</a></li>
<li class="toctree-l2"><a class="reference internal" href="findinpaths.auto.html">Find In Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="git_airgap_submodule_helper.auto.html">Git Airgap Submodule Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="git_functions.auto.html">Git Functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Git Mirror</a></li>
<li class="toctree-l2"><a class="reference internal" href="group_names.auto.html">Group Names</a></li>
<li class="toctree-l2"><a class="reference internal" href="inisin.auto.html">In Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="isin.auto.html">Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_accounts.auto.html">Linux Accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="lwhich.auto.html">Lwhich</a></li>
<li class="toctree-l2"><a class="reference internal" href="mount_tools.auto.html">Mount Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="nvidia_tools.auto.html">NVIDIA TOOLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="parser.auto.html">Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="pdbd.auto.html">PBDB - Primitive Bash Debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="picker.auto.html">Picker</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipenv_functions.auto.html">Pipenv Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="portable_patch.auto.html">Poratble Patch</a></li>
<li class="toctree-l2"><a class="reference internal" href="postisin.auto.html">Postisin</a></li>
<li class="toctree-l2"><a class="reference internal" href="preisin.auto.html">Preisin</a></li>
<li class="toctree-l2"><a class="reference internal" href="print_command.auto.html">Print Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_tools.auto.html">Python Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="quotemire.auto.html">Quotemire</a></li>
<li class="toctree-l2"><a class="reference internal" href="random.auto.html">Random</a></li>
<li class="toctree-l2"><a class="reference internal" href="real_path.auto.html">Real Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="reisin.auto.html">Regular Expression Is In</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.auto.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="set_flags.auto.html">Set Flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal_tools.auto.html">String Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="source_once.auto.html">Source once</a></li>
<li class="toctree-l2"><a class="reference internal" href="string_tools.auto.html">String Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_tools.auto.html">Time Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="uwecho.auto.html">Unwrapping Echo</a></li>
<li class="toctree-l2"><a class="reference internal" href="versions.auto.html">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="web_tools.auto.html">Web Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="yarp.auto.html">Yarp</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_scripts/modules.html">Pyhton Scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../style.html">Contributing Style Guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VSI Common</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Linux Utilities</a> &raquo;</li>
        
      <li>Git Mirror</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/linux/git_mirror.auto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="git-mirror">
<h1>Git Mirror<a class="headerlink" href="#git-mirror" title="Permalink to this headline">¶</a></h1>
<dl class="bash file">
<dt id="file-git_mirror">
<code class="sig-name descname"><span class="pre">git_mirror</span></code><a class="headerlink" href="#file-git_mirror" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>While creating a git mirror is as simple as <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--mirror</span></code>, unfortunately this git command does not support git submodules or lfs. The subcommands mirror, push and clone in this file, and associated functions, help in creating and subsequently cloning a mirror of a project with submodules and/or git lfs.</p>
<p class="rubric">Example</p>
<p>Example usage:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">mirror</span> <span class="pre">https://github.com/visionsystemsinc/vsi_common.git</span> <span class="pre">master</span></code> - Mirror the repository and recursively create mirrors of all submodules currently in the master branch.</p></li>
<li><p>Transfer <code class="docutils literal notranslate"><span class="pre">vsi_common_prep/transfer_{date}.tgz</span></code> to your destination</p></li>
<li><p>On the destination, create a directory, e.g., vsi_common_prep, and move the archive into it</p></li>
<li><p>Extract the archive (the archive will extract directly into this directory)</p></li>
<li><p>Write an <code class="docutils literal notranslate"><span class="pre">info.env</span></code> file mapping each repository to its mirrored URL:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>repos<span class="o">[</span>.<span class="o">]=</span>https://git-server.com/foobar/vsi_common.git
repos<span class="o">[</span>docker/recipes<span class="o">]=</span>https://git-server.com/foobar/recipes.git
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p><code class="docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">push</span> <span class="pre">./info.env</span> <span class="pre">./transfer_extracted_dir/</span></code> - Push the mirrored repository and all submodules to a new git server as defined by info.env</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git_mirror</span> <span class="pre">clone</span> <span class="pre">./info.env</span> <span class="pre">./my_project_dir/</span></code> - Clone recursively from the new mirror</p></li>
</ol>
<dl class="bash function">
<dt id="function-git_mirror next_section">
<code class="sig-name descname"><span class="pre">next_section</span></code><a class="headerlink" href="#function-git_mirror next_section" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Change the color of the text output to sdtout/stderr</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p>[<code class="docutils literal notranslate"><span class="pre">${&#64;}</span></code>] - An optional string (or list of strings) to harold the next section</p>
</dd>
<dt class="field-even">Output</dt>
<dd class="field-even"><p>A temporary file is created which stores the index into the COLORS array</p>
</dd>
</dl>
<p>Change the current text color. A temporary file is created to track the current index into the COLORS array; this index is updated with each call to this function. This temporary file will automatically be deleted</p>
<dl class="bash function">
<dt id="function-git_mirror get_config_submodule_names">
<code class="sig-name descname"><span class="pre">get_config_submodule_names</span></code><a class="headerlink" href="#function-git_mirror get_config_submodule_names" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Get list of initialized submodules, non-recursive</p>
<dl class="field-list simple">
<dt class="field-odd">Output</dt>
<dd class="field-odd"><p>A newline separated list of submodules for the current git repository</p>
</dd>
</dl>
<p>Get a list of submodules of the current git repository. This command is non-recursive, i.e., submodules of submodule, etc. are not returned. An implementation of this feature is provided for older versions of git (&lt;2.6)</p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ get_config_submodule_names<span class="o">()</span> <span class="c1"># from within ./vsi_common/</span>
submodule.docker/recipes
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span> <span class="pre">--quiet</span> <span class="pre">'echo</span> <span class="pre">&quot;${name}&quot;'</span></code>, this function works for submodules that have been init’d but not updated</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../just/plugins/just_git_functions.auto.html#function-just_git_functions.bsh submodule-helper-list"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">just_git_functions.bsh</span> <span class="pre">submodule-helper-list</span></code></a> and <a class="reference internal" href="git_functions.auto.html#function-git_functions.bsh git_submodule_names"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_functions.bsh</span> <span class="pre">git_submodule_names</span></code></a></p>
</div>
<dl class="bash function">
<dt id="function-git_mirror git_mirror_has_lfs">
<code class="sig-name descname"><span class="pre">git_mirror_has_lfs</span></code><a class="headerlink" href="#function-git_mirror git_mirror_has_lfs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Is git lfs available for the specified implementation of git</p>
<dl class="field-list simple">
<dt class="field-odd">Output</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code> - git lfs is available
<code class="docutils literal notranslate"><span class="pre">1</span></code> - git lfs is not available</p>
</dd>
<dt class="field-even">Internal Use</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">__git_mirror_has_lfs</span></code> - A variable to save this state</p>
</dd>
</dl>
<dl class="bash function">
<dt id="function-git_mirror clone_submodules">
<code class="sig-name descname"><span class="pre">clone_submodules</span></code><a class="headerlink" href="#function-git_mirror clone_submodules" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Mirror a submodule and all of its submodules (recursively)</p>
<p>This is a helper function to <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a>. Create a mirror of each submodule in a git repository, recursively. Each mirror is stored according to its full relative path in the project repository in a unique temporary directory created in the <code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code>. Submodules of a submodule are processed recursively in a depth-first fashion.</p>
<p>WARNING: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span></code> runs commands via sh because git is weird; however I start bash and source this script for its vars and functions, so it’s really bash again.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code> - The directory in which to mirror the repositories
[<code class="docutils literal notranslate"><span class="pre">base_submodule_path</span></code>] - The (relative) path from the project repository to a submodule with, potentially, submodules of its own that need to be mirrored/updated. This must also be the CWD. If unset, mirror the submodules of the parent repository.</p>
</dd>
<dt class="field-even">Output</dt>
<dd class="field-even"><p>A mirrored submodule located at <code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR/{temp_dir}/base_submodule_path</span></code></p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function assumes <code class="docutils literal notranslate"><span class="pre">base_submodule_path</span></code> is also the PWD</p>
</div>
<dl class="bash function">
<dt id="function-git_mirror update_submodules">
<code class="sig-name descname"><span class="pre">update_submodules</span></code><a class="headerlink" href="#function-git_mirror update_submodules" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Init/update a submodule and any of its submodules (recursively)</p>
<p>This is a helper function to <a class="reference internal" href="#function-git_mirror git_clone_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_clone_main</span></code></a>. Recursively clone a submodule mirrored with <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a>, and fixup the submodules’ remote URLs according to the mapping specified by <code class="docutils literal notranslate"><span class="pre">$1</span></code>.</p>
<p>WARNING: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span></code> runs commands via sh because git is weird; however I start bash and source this script for its vars and functions, so it’s really bash again.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A file specifying the mapping between each repository and its mirror URL; see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
[<code class="docutils literal notranslate"><span class="pre">base_submodule_path</span></code>] - The (relative) path from the project repository to a submodule with, potentially, submodules of its own that need to be cloned/updated. This must also be the CWD. If unset, update the submodules of the parent repository.
[<code class="docutils literal notranslate"><span class="pre">prefix</span></code>] - A variable set when calling <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span></code> (and, by necessity, re-exported by this function) to the submodule path (sm_path) from the .gitmodules file. After git v1.8.3, <code class="docutils literal notranslate"><span class="pre">prefix</span></code> was replaced with <code class="docutils literal notranslate"><span class="pre">displaypath</span></code>
[<code class="docutils literal notranslate"><span class="pre">displaypath</span></code>] - A variable set when calling <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span></code> (and, by necessity, re-exported by this function) to the relative path from the current working directory to the submodules root directory</p>
</dd>
<dt class="field-even">Output</dt>
<dd class="field-even"><p>The recursively cloned submodule</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function assumes <code class="docutils literal notranslate"><span class="pre">base_submodule_path</span></code> is also the PWD</p>
</div>
<dl class="bash function">
<dt id="function-git_mirror sync_submodules">
<code class="sig-name descname"><span class="pre">sync_submodules</span></code><a class="headerlink" href="#function-git_mirror sync_submodules" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Sync the submodules to the mirrored remote (non-recursive)</p>
<p>This is a helper function to <a class="reference internal" href="#function-git_mirror update_submodules"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">update_submodules</span></code></a>. Sync the submodules’ remote URLs (non-recursively), a la <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">sync</span></code>, however, instead of referring to the .gitmodules file, use the mapping specified by <code class="docutils literal notranslate"><span class="pre">repo_paths</span></code> and <code class="docutils literal notranslate"><span class="pre">repo_urls</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - The (relative) path from the project repository to a submodule with, potentially, submodules of its own that need to be sync’ed. This must also be the CWD. If unset, sync the submodules of the parent repository.</p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">repo_paths</span></code> - The array of (relative) paths from the root of the project repository to each submodule (recursively); see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
<code class="docutils literal notranslate"><span class="pre">repo_urls</span></code> - The corresponding URL of each repo_path</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function assumes <code class="docutils literal notranslate"><span class="pre">$1</span></code> is also the PWD</p>
</div>
<dl class="bash function">
<dt id="function-git_mirror git_mirror_main">
<code class="sig-name descname"><span class="pre">git_mirror_main</span></code><a class="headerlink" href="#function-git_mirror git_mirror_main" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Mirror the main repository and all submodules (recursively)</p>
<p>Downloads a mirror of a git repository and all of its submodules. The normal <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--mirror</span></code> command does not support submodules at all. This at least clones all the submodules available in the specified branch (master by default).</p>
<p>The script creates a directory, referred to as a prep directory (or prep_dir), which will contain all of the mirrored repositories plus a single <code class="docutils literal notranslate"><span class="pre">transfer_{date}.tgz</span></code> archive file containing all of these repositories, lfs objects, etc… Only this <cite>tgz</cite> file needs to be transferred to your destination.</p>
<p>Subsequent calls to <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a> can use the existing prep directory as cache, updating faster than the first time.</p>
<p>Subsequent calls also create a second <code class="docutils literal notranslate"><span class="pre">tgz</span></code> file, <code class="docutils literal notranslate"><span class="pre">transfer_{date1}_transfer_{date2}.tgz</span></code> (on supported platforms). This is an incremental archive file. Instead of having to bring in an entire archive, only the incremental file is needed (plus the original full archive).</p>
<p>After you have moved the transfer archive to its destination, you can use <a class="reference internal" href="#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_push_main</span></code></a> to push these mirrored repositories to a new git server.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - URL of the main git repository. On subsequent calls to this function, the prep (cache) dir created by this function can be used in lue of the repository’s URL</p></li>
<li><p>[<code class="docutils literal notranslate"><span class="pre">$2</span></code>] - The git branch from which to identify the submodules. Default: master</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p>[<code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code>] - The output directory in which to mirror the repositories; Default: <code class="docutils literal notranslate"><span class="pre">${PWD}/{repo_name}_prep</span></code></p>
</dd>
<dt class="field-odd">Output</dt>
<dd class="field-odd"><ul class="simple">
<li><p>A prep directory which will contain all of the repositories plus a single <code class="docutils literal notranslate"><span class="pre">transfer_{date}.tgz</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code> - The path to the mirrored repositories</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_MAIN_REPO</span></code> - The main repository’s name. Based off of <code class="docutils literal notranslate"><span class="pre">$1</span></code>; e.g., vsi_common if the URL is <a class="reference external" href="https://github.com/VisionSystemsInc/vsi_common.git">https://github.com/VisionSystemsInc/vsi_common.git</a></p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<p>Mirror the vsi_common repository and all of its submodules in a directory called ./vsi_common_prep. Then, create an archive file that can be transferred to your destination.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git_mirror_main https://github.com/visionsystemsinc/vsi_common.git master
<span class="c1"># produces ./vsi_common_prep/transfer_2020_03_02_14_16_09.tgz</span>
</pre></div>
</div>
<p class="rubric">Example</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">git_mirror</span></code> again will use the vsi_common_prep dir as a cache, and then create an incremental file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git_mirror_main vsi_common_prep
<span class="c1"># produces ./vsi_common_prep/transfer_2020_03_02_14_24_12_transfer_2020_03_02_14_16_09.tgz</span>
</pre></div>
</div>
<p class="rubric">Example</p>
<p>Both of these examples result in identical mirrors on your destination:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar zxf transfer_2020_03_02_14_16_09.tgz
tar --incremental zxf transfer_2020_03_02_14_24_12_transfer_2020_03_02_14_16_09.tgz
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar zxf transfer_2020_03_02_14_24_12.tgz
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">git_mirror_main</span></code> does not mirror all submodules that have ever been part of the repo, only those from a specific branch/SHA/tag you specify (master by default). This is because trying to mirror all submodules from the past could be very lengthy, and is very likely to include URLs that do not exist anymore.</p>
</div>
<p class="rubric">Bugs</p>
<p>If the first argument is a local path to a git repository (as opposed to a URL or a path to an existing prep dir), it must be an absolute path.</p>
<dl class="bash function">
<dt id="function-git_mirror git_mirror_repos">
<code class="sig-name descname"><span class="pre">git_mirror_repos</span></code><a class="headerlink" href="#function-git_mirror git_mirror_repos" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Mirror the main repository and all submodules (recursively)</p>
<p>Downloads a mirror of a git repository and all of its submodules. The normal <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--mirror</span></code> command does not support submodules at all. This at least clones all the submodules available in the specified branch (master by default).</p>
<p>Creates a directory, referred to as a prep directory (or prep_dir), which will contain all of the mirrored repositories. Subsequent calls to <a class="reference internal" href="#function-git_mirror git_mirror_repos"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_repos</span></code></a> can use the existing prep directory as cache, updating faster than the first time.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - URL of the main git repository. On subsequent calls to this function, the prep (cache) directory created by this function can be used in lue of the repository’s URL</p></li>
<li><p>[<code class="docutils literal notranslate"><span class="pre">$2</span></code>] - The git branch from which to identify the submodules. Default: master</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p>[<code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code>] - The output directory in which to mirror the repositories; Default: <code class="docutils literal notranslate"><span class="pre">${PWD}/{repo_name}_prep</span></code></p>
</dd>
<dt class="field-odd">Output</dt>
<dd class="field-odd"><ul class="simple">
<li><p>A prep directory which will contain all of the repositories</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_PREP_DIR</span></code> - The path to the mirrored repositories</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_MAIN_REPO</span></code> - The main repository’s name. Based off of <code class="docutils literal notranslate"><span class="pre">$1</span></code>; e.g., vsi_common if the URL is <a class="reference external" href="https://github.com/VisionSystemsInc/vsi_common.git">https://github.com/VisionSystemsInc/vsi_common.git</a></p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#function-git_mirror git_mirror_repos"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_repos</span></code></a> does not mirror all submodules that have ever been part of the repo, only those from a specific branch/SHA/tag you specify (master by default). This is because trying to mirror all submodules from the past could be very lengthy, and is very likely to include URLs that do not exist anymore.</p>
</div>
<p class="rubric">Bugs</p>
<p>If the first argument is a local path to a git repository (as opposed to a URL or a path to an existing prep dir), it must be an absolute path.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a></p>
</div>
<dl class="bash function">
<dt id="function-git_mirror archive_mirrors">
<code class="sig-name descname"><span class="pre">archive_mirrors</span></code><a class="headerlink" href="#function-git_mirror archive_mirrors" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Create an in-place archive of a directory</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">transfer_{date}.tgz</span></code> archive file of a directory. This archive is created within the same directory.</p>
<p>Subsequent calls also create a second <code class="docutils literal notranslate"><span class="pre">tgz</span></code> file, <code class="docutils literal notranslate"><span class="pre">transfer_{date1}_transfer_{date2}.tgz</span></code> (on supported platforms). This is an incremental archive file. Only the incremental file is needed (plus the original full archive).</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A directory to archive in-place</p></li>
</ul>
</dd>
<dt class="field-even">Output</dt>
<dd class="field-even"><p>A <code class="docutils literal notranslate"><span class="pre">transfer_{date}.tgz</span></code> archive file and, on subsequent calls, an incremental <code class="docutils literal notranslate"><span class="pre">transfer_{date1}_transfer_{date2}.tgz</span></code></p>
</dd>
</dl>
<dl class="bash function">
<dt id="function-git_mirror _git_mirror_load_info">
<code class="sig-name descname"><span class="pre">_git_mirror_load_info</span></code><a class="headerlink" href="#function-git_mirror _git_mirror_load_info" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Load the mapping between each repository and its mirror URL</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A file specifying the mapping between each repository and its mirror URL</p>
</dd>
<dt class="field-even">Output</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">repo_paths</span></code> - The array of (relative) paths from the root of the project repository to each submodule (recursively). (That is, a path as printed by <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">.</span> <span class="pre">&amp;&amp;</span> <span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">foreach</span> <span class="pre">-q</span> <span class="pre">'echo</span> <span class="pre">&quot;${displaypath}&quot;'</span></code> assuming the CWD is the root of the project repository)
<code class="docutils literal notranslate"><span class="pre">repo_urls</span></code> - The corresponding URL of each repo_path</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat info.env
<span class="nv">repo_paths</span><span class="o">=(</span>
  .
  docker/recipes
<span class="o">)</span>
<span class="nv">repo_urls</span><span class="o">=(</span>
  https://git-server.com/foobar/vsi_common.git
  https://git-server.com/foobar/recipes.git
<span class="o">)</span>
</pre></div>
</div>
<p>Or alternatively, using associative arrays:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>repos<span class="o">[</span>.<span class="o">]=</span>https://git-server.com/foobar/vsi_common.git
repos<span class="o">[</span>docker/recipes<span class="o">]=</span>https://git-server.com/foobar/recipes.git
</pre></div>
</div>
<dl class="bash function">
<dt id="function-git_mirror _git_mirror_get_url">
<code class="sig-name descname"><span class="pre">_git_mirror_get_url</span></code><a class="headerlink" href="#function-git_mirror _git_mirror_get_url" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Return the URL for a given submodule</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A path that can be found in <code class="docutils literal notranslate"><span class="pre">repo_paths</span></code></p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">repo_paths</span></code> - The array of (relative) paths from the root of the project repository to each submodule (recursively); see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
<code class="docutils literal notranslate"><span class="pre">repo_urls</span></code> - The corresponding URL of each repo_path</p>
</dd>
<dt class="field-odd">Output</dt>
<dd class="field-odd"><p>The URL corresponding to <code class="docutils literal notranslate"><span class="pre">$1</span></code></p>
</dd>
</dl>
<dl class="bash function">
<dt id="function-git_mirror git_clone_main">
<code class="sig-name descname"><span class="pre">git_clone_main</span></code><a class="headerlink" href="#function-git_mirror git_clone_main" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Clone recursively from the new mirror</p>
<p>Once the repository has been mirrored to the new git server with <a class="reference internal" href="#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_push_main</span></code></a>, it can be cloned. However, because the .gitmodules file will point to different URLs than the mirrors, and changing the .gitmodules file will change the repo, which we don’t want to do, we need to make a shallow clone of the repository, init the submodules, modify the submodules’ URLs, and then finally update the submodules. And all of this has to be done recursively for each submodule. As you can tell, this is very tedious, so this script will do it all for you.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A file specifying the mapping between each repository and its mirror URL; see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
[<code class="docutils literal notranslate"><span class="pre">$2</span></code>] - The directory in which to clone the repo</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git_clone_main init.env ~/
</pre></div>
</div>
<dl class="bash function">
<dt id="function-git_mirror git_push_main">
<code class="sig-name descname"><span class="pre">git_push_main</span></code><a class="headerlink" href="#function-git_mirror git_push_main" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Push the mirrored repository and all submodules to a new git server</p>
<p>After transferring the archive file created by <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a> to a prep directory on your destination and extracting the archive into it, this function pushes all the mirrored repositories in the extracted archive to your own mirrors on a new git server.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The mirrors must be initialized on the git server.</p>
</div>
<p>However, because the URLs for your mirrors will be different from the original repo URLs in .gitmodules, and modifying the URLs will change the git repo, which we do not want to do, you must create a file specifying the mapping between each repository and its mirror URL. The main repo is referred to as <code class="docutils literal notranslate"><span class="pre">.</span></code> while the rest of the repos are referred to by the relative path with respect to the main repo (e.g. <code class="docutils literal notranslate"><span class="pre">external/vsi_common</span></code>). These need to be stored in an associative array called <code class="docutils literal notranslate"><span class="pre">repos</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A file specifying the mapping between each repository and its mirror URL; see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
<code class="docutils literal notranslate"><span class="pre">$2</span></code> - The mirrored repositories (extracted from the archive) created by <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a></p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p>[<code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_FORCE_PUSH_REFS</span></code>] - A flag specifying whether to force push refs, should it be necessary. Default: 1 (force-push refs)</p>
</dd>
</dl>
<p class="rubric">Example</p>
<p>In this example, the main repo’s mirror URL is <code class="docutils literal notranslate"><span class="pre">https://git-server.com/foobar/vsi_common.git</span></code>, and the submodule stored at <code class="docutils literal notranslate"><span class="pre">./docker/recipes</span></code> has the URL <code class="docutils literal notranslate"><span class="pre">https://git-server.com/foobar/recipes.git</span></code>. This file is also used by <a class="reference internal" href="#function-git_mirror git_clone_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_clone_main</span></code></a>. (Any valid git URL format can be used.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat info.env
repos<span class="o">[</span>.<span class="o">]=</span>https://git-server.com/foobar/vsi_common.git
repos<span class="o">[</span>docker/recipes<span class="o">]=</span>https://git-server.com/foobar/recipes.git

$ git_push_main info.env vsi_common_prep
</pre></div>
</div>
<dl class="bash function">
<dt id="function-git_mirror git_tag_main">
<code class="sig-name descname"><span class="pre">git_tag_main</span></code><a class="headerlink" href="#function-git_mirror git_tag_main" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Tag the refs in the mirrored repository and all submodules</p>
<p>Before pushing the mirrored repository and all of its submodules to the new git server with <a class="reference internal" href="#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_push_main</span></code></a>, tag the refs so that if, during the <strong>next</strong> transfer, they become dereferenced (due to a force push, which is sometimes necessary), they are not lost. For a ref of the form refs/heads/master, this (annotated) tag takes the (long) form of refs/tags/just_git_mirror/{datetime}/heads/master</p>
<dl class="field-list simple">
<dt class="field-odd">Arguments</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">$1</span></code> - A file specifying the mapping between each repository and its mirror URL; see <a class="reference internal" href="#function-git_mirror _git_mirror_load_info"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">_git_mirror_load_info</span></code></a>
<code class="docutils literal notranslate"><span class="pre">$2</span></code> - The mirrored repositories (extracted from the archive) created by <a class="reference internal" href="#function-git_mirror git_mirror_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_mirror_main</span></code></a></p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p>[<code class="docutils literal notranslate"><span class="pre">GIT_MIRROR_TAG_REFS_REGEX</span></code>] - An extended regular expression specifying which refs to tag. The refs should be matched in their long form, e.g., refs/heads/master or refs/tags/v1.0.0. Default: ^refs/heads/.+</p>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-git_mirror git_push_main"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">git_push_main</span></code></a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because this function creates a tag directory called just_git_mirror/ (note the trailing slash), a user can no longer create a tag called just_git_mirror</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="group_names.auto.html" class="btn btn-neutral float-right" title="Group Names" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="git_functions.auto.html" class="btn btn-neutral float-left" title="Git Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Vision Systems, Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>