<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ci_load &mdash; VSI Common 0.2.2+1dev documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VSI Common
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../just/index.html">J.U.S.T. Useful Simple Tasking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../style.html">Contributing Style Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VSI Common</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">ci_load</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ci_load</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># DEPRECATED #</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span> <span class="k">as</span> <span class="n">env</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">yaml</span>

<span class="n">stage_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^ *from +[a-zA-Z0-9:\./_$</span><span class="si">{}</span><span class="s1">-]* +as +([^\n]*)&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">## Explanation how this script works:</span>

<span class="sd">#. Parses the docker-compose file. The docker-compose file is fed through ``docker-compose config`` so that all variables are substituted and anchors are expanded. This means that this needed to be run within ``just`` so that all environment variables are loaded.</span>
<span class="sd">#. A temporary &quot;push pull&quot; docker-compose yaml file is auto generated. This file will push and pull the cache from dockerhub (or whatever registry you decide to use)</span>
<span class="sd">#. The docker cache images are pulled</span>
<span class="sd">#. Another temporary docker-compose file is auto generated. This file is used to restore the recipes from the cache pulled, using cache-from. So if the image is pulled as &quot;vsi-ri/cache:recipe_gosu&quot; and the image name should be &quot;vsi-ri/recipe:gosu&quot;, it will let you build &quot;vsi-ri/recipe:gosu&quot; using &quot;--cache-from = vsi-ri/cache:gosu&quot;. Note: this is the ONBUILD recipes, not the gosu stage (recipe &quot;instance&quot;) that appears in your actual Dockerfile.</span>
<span class="sd">#. The recipes set up in step 3 are built</span>
<span class="sd">#. The recipes built in step 4 are re-tagged to their &quot;cached&quot; names, so that they are ready to be pushed at the end</span>
<span class="sd">#. A third docker-compose file is auto generated. The original docker-compose file is loaded, and a section for every single stage of the Dockerfile is copied based on the &quot;main service&quot; you specify. All of the possible &quot;cache from&quot; image names are added so that docker can build using the cache and the stages previously build. For example. If you build stage1 then stage2, stage2 shouldn&#39;t rebuild stage1, it should cache-from stage1, etc...</span>
<span class="sd">#. Unfortunately docker-compose cannot be used to build a multistage dockerfile efficiently, it will rebuild every stage for unknown reasons. So the docker-compose file is parsed and docker calls are made to build the stages in order. Finally, the main service stage (the final stage) is built, at this point all the previous stages have been built and cached, so only the last stage is built.</span>

<span class="sd">  * The (optional) other services are tagged from the cached images just generated (based on the target stage names found in the docker-compose file), and then the main service image is tagged too. This way the image names have been restored so that they are ready for CI to use.</span>

<span class="sd">#. Finally, that now updated images are push back to the registry</span>
<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="Popen2"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.Popen2">[docs]</a><span class="k">def</span> <span class="nf">Popen2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># import shlex</span>
  <span class="c1"># print(&#39;\x1b[31m&#39;+&#39; &#39;.join(shlex.quote(arg) for arg in args[0])+&#39;\x1b[0m&#39;)</span>
  <span class="n">pid</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">pid</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
  <span class="k">assert</span> <span class="n">pid</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="CiLoad"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad">[docs]</a><span class="k">class</span> <span class="nc">CiLoad</span><span class="p">:</span>

<div class="viewcode-block" id="CiLoad.setup"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.setup">[docs]</a>  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_compose_exe</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compose_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Get dockerfile name</span>
    <span class="n">build</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dockerfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dockerfile</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>

    <span class="n">dockerfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dockerfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># get stage names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">stage_pattern</span><span class="p">,</span> <span class="n">dockerfile</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="o">+</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

    <span class="c1"># get recipes used</span>
    <span class="n">recipe_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_repo</span><span class="p">)</span>
    <span class="n">recipe_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^ *from +</span><span class="si">{</span><span class="n">recipe_pattern</span><span class="si">}</span><span class="s1">:([^ \n]+)&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">recipe_pattern</span><span class="p">,</span> <span class="n">dockerfile</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="o">+</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span></div>

<div class="viewcode-block" id="CiLoad.get_dockerfile"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.get_dockerfile">[docs]</a>  <span class="k">def</span> <span class="nf">get_dockerfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;context&#39;</span> <span class="ow">in</span> <span class="n">build</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;dockerfile&#39;</span> <span class="ow">in</span> <span class="n">build</span><span class="p">:</span>
        <span class="n">dockerfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;dockerfile&#39;</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">dockerfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="s1">&#39;Dockerfile&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dockerfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build</span><span class="p">,</span> <span class="s1">&#39;Dockerfile&#39;</span><span class="p">)</span>

    <span class="c1"># If it&#39;s relative, it&#39;s relative to the compose file (or project-dir,</span>
    <span class="c1"># not supported)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dockerfile</span><span class="p">):</span>
      <span class="n">dockerfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">dockerfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">dockerfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="CiLoad.cache_image"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.cache_image">[docs]</a>  <span class="k">def</span> <span class="nf">cache_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># default cache_location</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_loc</span><span class="p">:</span>
      <span class="n">cache_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_repo</span>

    <span class="c1"># cache_loc of the form &quot;vsiri/cache:tag_header&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">cache_loc</span><span class="p">:</span>
      <span class="n">cache_repo</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">cache_loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
      <span class="n">cache_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">]</span>

    <span class="c1"># cache_loc of the form &quot;vsiri/cache&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cache_repo</span> <span class="o">=</span> <span class="n">cache_loc</span>
      <span class="n">cache_tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">]</span>

    <span class="c1"># assemble cache image string</span>
    <span class="n">cache_tag</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cache_tags</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cache_repo</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">cache_tag</span><span class="si">}</span><span class="s1">&#39;</span></div>

  <span class="c1"># 1 Generate push &amp; pull config _dynamic_docker-compose_push_pull</span>
<div class="viewcode-block" id="CiLoad.generate_push_pull_config"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.generate_push_pull_config">[docs]</a>  <span class="k">def</span> <span class="nf">generate_push_pull_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_service_dict</span><span class="p">(</span><span class="n">cache_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
      <span class="n">services</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
      <span class="n">services</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;final_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cache_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;build&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">)}</span>
      <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
        <span class="n">services</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;stage_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cache_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;build&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">)}</span>
      <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
        <span class="n">services</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;recipe_</span><span class="si">{</span><span class="n">recipe</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cache_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;build&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">)}</span>
      <span class="k">return</span> <span class="n">services</span>

    <span class="c1"># pull dictionary</span>
    <span class="n">services</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cache_id</span><span class="p">,</span> <span class="n">cache_loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_repo</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_repos</span><span class="p">):</span>
      <span class="n">services</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_service_dict</span><span class="p">(</span><span class="n">cache_id</span><span class="p">,</span> <span class="n">cache_loc</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pull_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.5&#39;</span><span class="p">,</span> <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">services</span><span class="p">}</span>

    <span class="c1"># push dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">push_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.5&#39;</span><span class="p">,</span> <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">_service_dict</span><span class="p">()}</span></div>

  <span class="c1"># 2 pull images</span>
<div class="viewcode-block" id="CiLoad.pull_images"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.pull_images">[docs]</a>  <span class="k">def</span> <span class="nf">pull_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pull</span><span class="p">:</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_push_pull</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PULL CONFIGURATION:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pull_dict</span><span class="p">))</span>

      <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pull_file</span><span class="p">:</span>
        <span class="n">pull_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pull_dict</span><span class="p">))</span>
        <span class="n">pull_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">pull_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_compose_exe</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">pull_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pull&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;--ignore-pull-failures&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet_pull</span><span class="p">:</span>
          <span class="n">pull_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-q&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pulling available images...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">Popen2</span><span class="p">(</span><span class="n">pull_cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pull_cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt; failed; images may not exist yet&quot;</span><span class="p">)</span></div>

  <span class="c1"># 3. _dynamic_docker-compose_restore_recipes</span>
<div class="viewcode-block" id="CiLoad.write_restore_recipe"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.write_restore_recipe">[docs]</a>  <span class="k">def</span> <span class="nf">write_restore_recipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">restore_recipe_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">compose_yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_compose</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>

    <span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
      <span class="n">services</span><span class="p">[</span><span class="n">recipe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">services</span><span class="p">[</span><span class="n">recipe</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">services</span><span class="p">[</span><span class="n">recipe</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;cache_from&#39;</span><span class="p">]</span> <span class="o">=</span> \
          <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">),</span>
           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_repo</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">recipe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

    <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">services</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">restore_recipe_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">restore_recipe_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

  <span class="c1"># 4 docker-compose build</span>
  <span class="c1"># 5 tag recipes</span>
<div class="viewcode-block" id="CiLoad.restore_recipes"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.restore_recipes">[docs]</a>  <span class="k">def</span> <span class="nf">restore_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
      <span class="n">Popen2</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_compose_exe</span><span class="p">,</span>
              <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_compose</span><span class="p">,</span>
              <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_recipe_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">])</span>

      <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
        <span class="n">Popen2</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_exe</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_repo</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">recipe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)])</span></div>

<div class="viewcode-block" id="CiLoad.add_cache_from"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.add_cache_from">[docs]</a>  <span class="k">def</span> <span class="nf">add_cache_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_services</span><span class="p">:</span>
      <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
      <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_repo</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">recipe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cache_loc</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_repo</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_repos</span><span class="p">:</span>
      <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">stage_from</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
        <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="n">stage_from</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipes</span><span class="p">:</span>
        <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">,</span> <span class="n">cache_loc</span><span class="o">=</span><span class="n">cache_loc</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cf</span></div>


  <span class="c1"># 6 _dynamic_docker-compose_add_cache_from</span>
<div class="viewcode-block" id="CiLoad.write_add_cache"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.write_add_cache">[docs]</a>  <span class="k">def</span> <span class="nf">write_add_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_stages_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># self.add_stages_cache_file = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>

    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
      <span class="n">stage_service_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="si">}</span><span class="s1">_auto_gen_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="k">if</span> <span class="n">stage_service_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stage_service_name</span><span class="si">}</span><span class="s1"> is already a service.&#39;</span><span class="p">)</span>
      <span class="n">service</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">])</span>
      <span class="c1"># Set image name (for pushing)</span>
      <span class="n">service</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>
      <span class="c1"># Set build target</span>
      <span class="k">if</span> <span class="s1">&#39;build&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">service</span><span class="p">:</span>
        <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]:</span>
        <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span>
      <span class="c1"># Setup cache_from</span>
      <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;cache_from&#39;</span><span class="p">]</span> <span class="o">=</span> \
          <span class="bp">self</span><span class="o">.</span><span class="n">add_cache_from</span><span class="p">(</span><span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_from&#39;</span><span class="p">,</span> <span class="p">[]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">stage_service_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>

    <span class="c1"># Add cache_from for services</span>
    <span class="k">for</span> <span class="n">service_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_services</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;build&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cache_from</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
              <span class="s1">&#39;cache_from&#39;</span><span class="p">,</span> <span class="p">[]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;cache_from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">add_stages_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">,</span>
                                         <span class="n">Dumper</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Dumper</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_stages_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

  <span class="c1"># 7 build</span>
<div class="viewcode-block" id="CiLoad.build_stages"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.build_stages">[docs]</a>  <span class="k">def</span> <span class="nf">build_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_stages_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">main_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_yaml</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_build</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BUILD CONFIGURATION:&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build_stage</span><span class="p">(</span><span class="n">stage_name</span><span class="p">):</span>
      <span class="n">build</span> <span class="o">=</span> <span class="n">yaml_content</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span>
      <span class="n">image_name</span> <span class="o">=</span> <span class="n">yaml_content</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

      <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_exe</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">]</span>
      <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dockerfile</span><span class="p">(</span><span class="n">build</span><span class="p">)]</span>
      <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">in</span> <span class="n">build</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--target&#39;</span><span class="p">,</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="c1"># Already been expanded by config</span>
        <span class="c1"># value = os.path.expandvars(build[&quot;args&quot;][arg])</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--build-arg&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">build</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_from&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--cache-from&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="p">]</span>
      <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">image_name</span><span class="p">]</span>
      <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">build</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]]</span>
      <span class="n">Popen2</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">:</span>
      <span class="c1"># Build all the stages with names in the Dockerfile</span>
      <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
        <span class="n">build_stage</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="si">}</span><span class="s1">_auto_gen_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

      <span class="c1"># Build the main (last) stage here</span>
      <span class="n">build_stage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_service</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_services</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_exe</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">]</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">yaml_content</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service</span><span class="p">][</span><span class="s1">&#39;build&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">yaml_content</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
        <span class="n">Popen2</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">Popen2</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_exe</span><span class="p">,</span>
            <span class="s1">&#39;tag&#39;</span><span class="p">,</span>
            <span class="n">main_image</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_image</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">)])</span></div>

  <span class="c1"># 8 push</span>
<div class="viewcode-block" id="CiLoad.push_images"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.push_images">[docs]</a>  <span class="k">def</span> <span class="nf">push_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">:</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_push_pull</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PUSH CONFIGURATION:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_dict</span><span class="p">))</span>

      <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">push_file</span><span class="p">:</span>
        <span class="n">push_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_dict</span><span class="p">))</span>
        <span class="n">push_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">Popen2</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_compose_exe</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">push_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="CiLoad.setup_parser"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.setup_parser">[docs]</a>  <span class="k">def</span> <span class="nf">setup_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--docker-compose-exe&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;docker-compose&#39;</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Docker compose exectuable&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--docker-exe&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Docker exectuable&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--project-dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The compose project dir. Default: docker-compose.yml dir&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--cache-repo&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;vsiri/ci_cache&#39;</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Docker repo for storing cache images&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--other-repos&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Additional docker repo(s) to check for cache images&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--cache-version&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cache version&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--recipe-repo&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;vsiri/recipe&#39;</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Repo recipes (ONBUILD) images are in&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--recipe-compose&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
       <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;VSI_COMMON_DIR&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;docker/recipes/docker-compose.yml&quot;</span><span class="p">),</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Recipe compose file&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pull&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable pulling images (default)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-pull&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable pulling images&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">pull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--build&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable building images (default)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-build&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable building images&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--push&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable pushing images&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-push&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable pushing images (default)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--quiet-pull&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;quiet_pull&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
       <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Quiet pull (no progress bars)&#39;</span><span class="p">)</span>

    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--print-push-pull&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;print_push_pull&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
       <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print push/pull configuration&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;--print-build&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;print_build&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
       <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print build configuration&#39;</span><span class="p">)</span>

    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;compose&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Docker compose yaml file&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;main_service&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Main docker-compose service&#39;</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Additional services to be tagged&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CiLoad.parse"><a class="viewcode-back" href="../linux/python_scripts/ci_load.html#ci_load.CiLoad.parse">[docs]</a>  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">compose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main_service</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">main_service</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">other_services</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">services</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache_repo</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_repo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">other_repos</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">other_repos</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache_version</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_version</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recipe_repo</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">recipe_repo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recipe_compose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">recipe_compose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">docker_compose_exe</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">docker_compose_exe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">docker_exe</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">docker_exe</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">push</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">push</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pull</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pull</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">build</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">quiet_pull</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet_pull</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">print_push_pull</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">print_push_pull</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">print_build</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">print_build</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">project_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">project_dir</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compose</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compose</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span><span class="p">))</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">ci_load</span> <span class="o">=</span> <span class="n">CiLoad</span><span class="p">()</span>
  <span class="n">ci_load</span><span class="o">.</span><span class="n">setup_parser</span><span class="p">()</span>
  <span class="n">ci_load</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

  <span class="n">ci_load</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

  <span class="n">ci_load</span><span class="o">.</span><span class="n">generate_push_pull_config</span><span class="p">()</span>
  <span class="n">ci_load</span><span class="o">.</span><span class="n">pull_images</span><span class="p">()</span>

  <span class="n">ci_load</span><span class="o">.</span><span class="n">write_restore_recipe</span><span class="p">()</span>
  <span class="n">ci_load</span><span class="o">.</span><span class="n">restore_recipes</span><span class="p">()</span>

  <span class="n">ci_load</span><span class="o">.</span><span class="n">write_add_cache</span><span class="p">()</span>
  <span class="n">ci_load</span><span class="o">.</span><span class="n">build_stages</span><span class="p">()</span>

  <span class="n">ci_load</span><span class="o">.</span><span class="n">push_images</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Vision Systems, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>