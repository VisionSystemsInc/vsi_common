<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VSI Testlib &mdash; VSI Common 0.2.2+1dev documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="vsi" href="../python/modules.html" />
    <link rel="prev" title="Test Utilities" href="test_utils.auto.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VSI Common
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../just/index.html">J.U.S.T. Useful Simple Tasking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Unit Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="run_tests.auto.html">Run Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_colors.auto.html">Test Colors</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_utils.auto.html">Test Utilities</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">VSI Testlib</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/recipes/index.html">Docker recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../style.html">Contributing Style Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VSI Common</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Unit Tests</a></li>
      <li class="breadcrumb-item active">VSI Testlib</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tests/testlib.auto.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="vsi-testlib">
<h1>VSI Testlib<a class="headerlink" href="#vsi-testlib" title="Permalink to this heading"></a></h1>
<dl class="bash file">
<dt class="sig sig-object bash" id="file-testlib.bsh">
<span class="sig-name descname"><span class="pre">testlib.bsh</span></span><a class="headerlink" href="#file-testlib.bsh" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Simple shell command language test library</p>
<dl class="field-list">
<dt class="field-odd">Copyright<span class="colon">:</span></dt>
<dd class="field-odd"><p>Original version: (c) 2011-13 by Ryan Tomayko &lt;<a class="reference external" href="http://tomayko.com">http://tomayko.com</a>&gt;</p>
<p>License: MIT</p>
</dd>
</dl>
<p>## Writing unit tests</p>
<p>Testlib gives you a number of basic unit test functionality from bash, including:</p>
<ul class="simple">
<li><p>Running tests in subshells to prevent environment variable pollution.</p></li>
<li><p>An automatically self deleting <span class="target" id="index-0"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a> for all the tests</p></li>
<li><p>An automatically self deleting <span class="target" id="index-1"></span><a class="reference internal" href="#envvar-TESTDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTDIR</span></code></a> for each individual test (in the <span class="target" id="index-2"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a>)</p></li>
<li><p>A tally of successfully run and failed tests, in addition to expected failures, unexpected successes, required failures, and skipped tests</p></li>
<li><p>Individual est times: <span class="target" id="index-3"></span><a class="reference internal" href="#envvar-TESTLIB_SHOW_TIMING"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_SHOW_TIMING</span></code></a></p></li>
<li><p>A user defined <a class="reference internal" href="#function-testlib.bsh setup"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup</span></code></a> function run before the first test in a file</p></li>
<li><p>A user defined <a class="reference internal" href="#function-testlib.bsh teardown"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">teardown</span></code></a> function run after the last test in a file</p></li>
<li><p>Keep temporary directories for debugging: <span class="target" id="index-4"></span><a class="reference internal" href="#envvar-TESTLIB_KEEP_TEMP_DIRS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_KEEP_TEMP_DIRS</span></code></a></p></li>
<li><p>Pause before deleting temporary directories if there is a failure for inspection: <span class="target" id="index-5"></span><a class="reference internal" href="#envvar-TESTLIB_KEEP_PAUSE_AFTER_ERROR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_KEEP_PAUSE_AFTER_ERROR</span></code></a></p></li>
<li><p>Run only a single test by its description: <span class="target" id="index-6"></span><a class="reference internal" href="#envvar-TESTLIB_RUN_SINGLE_TEST"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_RUN_SINGLE_TEST</span></code></a></p></li>
<li><p>Regular expression to skip tests by description: <span class="target" id="index-7"></span><a class="reference internal" href="#envvar-TESTLIB_SKIP_TESTS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_SKIP_TESTS</span></code></a></p></li>
<li><p>Controlled stderr/stdout redirection <span class="target" id="index-8"></span><a class="reference internal" href="#envvar-TESTLIB_REDIRECT_OUTPUT"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_REDIRECT_OUTPUT</span></code></a></p></li>
<li><p>Stop testing after <code class="docutils literal notranslate"><span class="pre">N</span></code> failures <span class="target" id="index-9"></span><a class="reference internal" href="#envvar-TESTLIB_STOP_AFTER_FAILS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_STOP_AFTER_FAILS</span></code></a></p></li>
<li><p>Custom PS4 in trace using <span class="target" id="index-10"></span><a class="reference internal" href="#envvar-TESTLIB_PS4"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_PS4</span></code></a></p></li>
<li><p>Ability to conditionally skip a test by calling <a class="reference internal" href="#function-testlib.bsh skip_next_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">skip_next_test</span></code></a> in any condition check</p></li>
<li><p>Track files outside the <span class="target" id="index-11"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a> with <a class="reference internal" href="#function-testlib.bsh ttouch"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">ttouch</span></code></a> so that they will be automatically deleted during cleanup.</p></li>
<li><p>Other helper functions like <a class="reference internal" href="test_utils.auto.html#function-test_utils.bsh not"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">test_utils.bsh</span> <span class="pre">not</span></code></a>, <a class="reference internal" href="test_utils.auto.html#function-test_utils.bsh not_s"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">test_utils.bsh</span> <span class="pre">not_s</span></code></a>, <a class="reference internal" href="test_utils.auto.html#function-test_utils.bsh assert_array_values"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">test_utils.bsh</span> <span class="pre">assert_array_values</span></code></a>, <a class="reference internal" href="test_utils.auto.html#function-test_utils.bsh assert_array_regex_values"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">test_utils.bsh</span> <span class="pre">assert_array_regex_values</span></code></a>, <a class="reference internal" href="test_utils.auto.html#function-test_utils.bsh assert_array_contiguous"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">test_utils.bsh</span> <span class="pre">assert_array_contiguous</span></code></a></p></li>
<li><p>Auto discover and run tests script: <a class="reference internal" href="run_tests.auto.html#file-run_tests"><code class="xref bash bash-file docutils literal notranslate"><span class="pre">run_tests</span></code></a></p></li>
</ul>
<p class="rubric">Example</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Tests must follow the basic form:</span><a class="headerlink" href="#id1" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>testlib.bsh

begin_test<span class="w"> </span><span class="s2">&quot;the thing&quot;</span>
<span class="o">(</span>
<span class="w">     </span><span class="nb">set</span><span class="w"> </span>-e
<span class="w">     </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span>
<span class="w">     </span><span class="o">[</span><span class="w"> </span><span class="nv">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="c1"># this is ok</span>
<span class="w">     </span><span class="c1"># However, the following needs &quot;|| false&quot; because on bash 3.2 and 4.0</span>
<span class="w">     </span><span class="c1"># there is a bug where [[ ]] will fail, and bash knows it fails ($?),</span>
<span class="w">     </span><span class="c1"># but &quot;set -e&quot; does not count this as an error. This is fixed in bash 4.1</span>
<span class="w">     </span><span class="o">[[</span><span class="w"> </span><span class="nv">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">false</span>
<span class="w">     </span><span class="nb">false</span>
<span class="o">)</span>
end_test

Any<span class="w"> </span><span class="nb">command</span><span class="w"> </span>that<span class="w"> </span>evaluates<span class="w"> </span>to<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="s2">&quot;fails&quot;</span><span class="w"> </span>the<span class="w"> </span>test.<span class="w"> </span>When<span class="w"> </span>a<span class="w"> </span><span class="nb">test</span><span class="w"> </span>fails,<span class="w"> </span>its<span class="w"> </span>stdout,<span class="w"> </span>stderr,<span class="w"> </span>and<span class="w"> </span>call<span class="w"> </span>trace<span class="w"> </span>are<span class="w"> </span>printed<span class="w"> </span>out.
</pre></div>
</div>
</div>
<p class="rubric">Bugs</p>
<p>On darling: when debugging a unit test error, sometimes the printout is cut off, making it difficult to do “printf debugging.” While the cause and scope of this is unknown, a work around that sometimes works is</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>runtests<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>less<span class="w"> </span>-R
</pre></div>
</div>
<p>## Test status</p>
<p>Every test will print out a line with its name, and the status of the test run.</p>
<p>Possible results of a test:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OK</span></code> - The test passed!</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FAILED</span></code> - The test did not pass. A trace is printed out for debugging.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SETUP</span> <span class="pre">FAILURE</span></code> - Each test must call <a class="reference internal" href="#function-testlib.bsh setup_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup_test</span></code></a>, and it was not detected for this test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SKIPPED</span></code> - The test was not run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FAIL</span> <span class="pre">REQUIRED</span></code> - A test successfully failed as it is required to. If the test succeeds, it is treated as a failed test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FAIL</span> <span class="pre">EXPECTED</span></code> - A test successfully failed as it is expected to. If the test succeeds, it is treated as an unexpected success.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHOULD</span> <span class="pre">HAVE</span> <span class="pre">FAILED</span> <span class="pre">ELSEWHERE</span></code> - A required or expected to fail test failed in an the wrong area of the code. There is something wrong with the test, and a trace is printed out for debugging.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHOULD</span> <span class="pre">HAVE</span> <span class="pre">FAILED</span></code> - A required to fail test did not fail. There is something wrong with the test, and a trace is printed out for debugging.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNEXPECTED</span> <span class="pre">SUCCESS</span></code> - An expected to fail test never actually failed. This doesn’t count as a failure, but a middle ground in its own category.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">REQUIRED</span> <span class="pre">FAILURE</span> <span class="pre">SETUP</span> <span class="pre">ERROR</span></code> - A required to fail test did not call <a class="reference internal" href="#function-testlib.bsh begin_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_fail_zone</span></code></a> and is considered setup incorrectly.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXPECTED</span> <span class="pre">FAILURE</span> <span class="pre">SETUP</span> <span class="pre">ERROR</span></code> - An expected to fail test did not call <a class="reference internal" href="#function-testlib.bsh begin_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_fail_zone</span></code></a> and is considered setup incorrectly.</p></li>
</ul>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh setup">
<span class="sig-name descname"><span class="pre">setup</span></span><a class="headerlink" href="#function-testlib.bsh setup" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Function run before the first test. Must be declared before the first test is called in the test file, or else it will not be discovered in time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A directory <span class="target" id="index-12"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a> is created for setup, right before running <a class="reference internal" href="#function-testlib.bsh setup"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup</span></code></a> ().</p>
<p>Setup is not run if no tests are ever run</p>
</div>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TRASHDIR">
<span class="sig-name descname"><span class="pre">TRASHDIR</span></span><a class="headerlink" href="#envvar-TRASHDIR" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Temporary directory where everything for the test file is stored</p>
<p>Automatically generated and removed (unless <span class="target" id="index-13"></span><a class="reference internal" href="#envvar-TESTLIB_KEEP_TEMP_DIRS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_KEEP_TEMP_DIRS</span></code></a> is changed)</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="target" id="index-14"></span><a class="reference internal" href="#envvar-TESTDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTDIR</span></code></a></p>
</div>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTDIR">
<span class="sig-name descname"><span class="pre">TESTDIR</span></span><a class="headerlink" href="#envvar-TESTDIR" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Unique temporary directory for a single test (in <span class="target" id="index-15"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a>)</p>
<p>Automatically generated and removed (unless <span class="target" id="index-16"></span><a class="reference internal" href="#envvar-TESTLIB_KEEP_TEMP_DIRS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_KEEP_TEMP_DIRS</span></code></a> is changed)</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="target" id="index-17"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a></p>
</div>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_DIR">
<span class="sig-name descname"><span class="pre">TESTLIB_DIR</span></span><a class="headerlink" href="#envvar-TESTLIB_DIR" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Directory of testlib’s source code</p>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh teardown">
<span class="sig-name descname"><span class="pre">teardown</span></span><a class="headerlink" href="#function-testlib.bsh teardown" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Function run after the last test</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Teardown is not run if no tests are ever run</p>
</div>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_KEEP_TEMP_DIRS">
<span class="sig-name descname"><span class="pre">TESTLIB_KEEP_TEMP_DIRS</span></span><a class="headerlink" href="#envvar-TESTLIB_KEEP_TEMP_DIRS" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Keep the trashdir/setup dir</p>
<p>Debug flag to keep the temporary directories generated when testing. Set to <code class="docutils literal notranslate"><span class="pre">1</span></code> to keep directories.</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_KEEP_PAUSE_AFTER_ERROR">
<span class="sig-name descname"><span class="pre">TESTLIB_KEEP_PAUSE_AFTER_ERROR</span></span><a class="headerlink" href="#envvar-TESTLIB_KEEP_PAUSE_AFTER_ERROR" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Pauses before allowing testlib to cleanup and delete all temporary files.</p>
<p>A better alternative to <span class="target" id="index-18"></span><a class="reference internal" href="#envvar-TESTLIB_KEEP_TEMP_DIRS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_KEEP_TEMP_DIRS</span></code></a>, so that you are given time to investigate a problem, and can then press any key to cleanup the temporary directory</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_SHOW_TIMING">
<span class="sig-name descname"><span class="pre">TESTLIB_SHOW_TIMING</span></span><a class="headerlink" href="#envvar-TESTLIB_SHOW_TIMING" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Display test time after each test</p>
<p>Debug flag to display time elapsed for each test. Set to <code class="docutils literal notranslate"><span class="pre">1</span></code> to enable.</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_RUN_SINGLE_TEST">
<span class="sig-name descname"><span class="pre">TESTLIB_RUN_SINGLE_TEST</span></span><a class="headerlink" href="#envvar-TESTLIB_RUN_SINGLE_TEST" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Run a single test</p>
<p>Instead of running all the tests in a test file, only the tests with a description exactly matching the value of <span class="target" id="index-19"></span><a class="reference internal" href="#envvar-TESTLIB_RUN_SINGLE_TEST"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTLIB_RUN_SINGLE_TEST</span></code></a> will be run. Useful for debugging a specific test/piece of code</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>unset</em></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_SKIP_TESTS">
<span class="sig-name descname"><span class="pre">TESTLIB_SKIP_TESTS</span></span><a class="headerlink" href="#envvar-TESTLIB_SKIP_TESTS" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>A bash regex expressions that designates tests to be skipped.</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>unset</em></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">TESTLIB_SKIP_TESTS</span><span class="o">=</span><span class="s1">&#39;^New Just$|foo&#39;</span>
<span class="c1"># Skip &quot;New Just&quot; and anything with &quot;foo&quot; it is, e.g. &quot;food&quot;</span>
</pre></div>
</div>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_REDIRECT_OUTPUT">
<span class="sig-name descname"><span class="pre">TESTLIB_REDIRECT_OUTPUT</span></span><a class="headerlink" href="#envvar-TESTLIB_REDIRECT_OUTPUT" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Redirects stdout and stderr to temporary files</p>
<p>By default, all tests are run with <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-xv</span></code> for debugging purposes when a tests fails. This output is stored in a out/err/xtrace file temporarily and only displayed if a tests fails. You can set this variable to control the streams to always output.</p>
<dl class="field-list simple">
<dt class="field-odd">Values<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">3</span></code> Redirect stdout, stderr, and xtrace</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> Redirect stderr, and xtrace, but let stdout through</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> Redirect xtrace, but let stdout and stderr through. On bash 4.0 and older, this will let xtrace through too</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> Let everything through</p></li>
</ul>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_PS4">
<span class="sig-name descname"><span class="pre">TESTLIB_PS4</span></span><a class="headerlink" href="#envvar-TESTLIB_PS4" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Optionally set a custom PS4 output for trace output on test errors. If unset, the testlib default is use: <code class="docutils literal notranslate"><span class="pre">+${BASH_SOURCE[0]##*/}:${LINENO})\t</span></code></p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>unset</em></p>
</dd>
</dl>
<dl class="std envvar">
<dt class="sig sig-object std" id="envvar-TESTLIB_STOP_AFTER_FAILS">
<span class="sig-name descname"><span class="pre">TESTLIB_STOP_AFTER_FAILS</span></span><a class="headerlink" href="#envvar-TESTLIB_STOP_AFTER_FAILS" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>If set, stops after this many tests have fails in a single file. Instead of running the rest of the tests in a file, they are skipped.</p>
<dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code> - Unlimited</p>
</dd>
</dl>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh atexit">
<span class="sig-name descname"><span class="pre">atexit</span></span><a class="headerlink" href="#function-testlib.bsh atexit" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Function that runs at process exit</p>
<p class="rubric">Usage</p>
<p>Automatically called on exit by trap.</p>
<p>Checks to see if <a class="reference internal" href="#function-testlib.bsh teardown"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">teardown</span></code></a> is defined, and calls it. <a class="reference internal" href="#function-testlib.bsh teardown"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">teardown</span></code></a> is typically a function, alias, or something that makes sense to call.</p>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh begin_test">
<span class="sig-name descname"><span class="pre">begin_test</span></span><a class="headerlink" href="#function-testlib.bsh begin_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Beginning of test demarcation</p>
<p class="rubric">Usage</p>
<p>Mark the beginning of a test. A subshell should immediately follow this statement.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh end_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_test</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh begin_expected_fail_test">
<span class="sig-name descname"><span class="pre">begin_expected_fail_test</span></span><a class="headerlink" href="#function-testlib.bsh begin_expected_fail_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Beginning of expected to fail test demarcation</p>
<p class="rubric">Usage</p>
<p>Define the beginning of a test that is expected to fail. Failures may only occur in “fail zones” denoted by <a class="reference internal" href="#function-testlib.bsh begin_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_fail_zone</span></code></a> and <a class="reference internal" href="#function-testlib.bsh end_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_fail_zone</span></code></a>. When a test fails in a fail zone, it is counted as a success. If a test that was expected to fail never fails, it counts as an “unexpected success” rather than a normal success. If the test fails outside a fail zone, it is marked as a failure.</p>
<p>The typical use case for expecting a failure is when a known bug is being tested and has not or cannot be fixed yet. For this reason, a success is counted as an “unexpected success” rather than a normal success. While unexpected successes do not cause a non-zero exit code, they can easily be noticed as something that should be checked out.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#function-testlib.bsh end_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_fail_zone</span></code></a> is not typically needed.</p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh begin_required_fail_test">
<span class="sig-name descname"><span class="pre">begin_required_fail_test</span></span><a class="headerlink" href="#function-testlib.bsh begin_required_fail_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Beginning of required to fail test demarcation</p>
<p class="rubric">Usage</p>
<p>Define the beginning of a test that is required to fail. Failures may only occur in “fail zones” denoted by <a class="reference internal" href="#function-testlib.bsh begin_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_fail_zone</span></code></a> and <a class="reference internal" href="#function-testlib.bsh end_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_fail_zone</span></code></a>. When a test fails in a fail zone, it is counted as a success. If a test that was required to fail never fails, it counts as a failure. If the test fails outside a fail zone, it is marked as a failure.</p>
<p>The typical use case for requiring a failure is testing that an exception is raise under proper circumstances.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#function-testlib.bsh end_fail_zone"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_fail_zone</span></code></a> is not typically needed.</p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh begin_fail_zone">
<span class="sig-name descname"><span class="pre">begin_fail_zone</span></span><a class="headerlink" href="#function-testlib.bsh begin_fail_zone" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Start a fail zone</p>
<p>In practice, having a test that is expected or required to fail leads to the possibility of a test failing somewhere you don’t expect it to. For this reason, fail zones must be denoted in order for <a class="reference internal" href="#function-testlib.bsh begin_expected_fail_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_expected_fail_test</span></code></a> and <a class="reference internal" href="#function-testlib.bsh begin_required_fail_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_required_fail_test</span></code></a> tests to succeed, and the failures must only occur in a fail zone. If a failure happens outside the fail zone, the test will be marked as a failure with the message <code class="docutils literal notranslate"><span class="pre">SHOULD</span> <span class="pre">HAVE</span> <span class="pre">FAILED</span> <span class="pre">ELSEWHERE</span></code>.</p>
<p>Typically this will be called right before the last last line of a test</p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>begin_expected_fail_test<span class="w"> </span><span class="s2">&quot;Some test&quot;</span>
<span class="o">(</span>
<span class="w">  </span>setup_test
<span class="w">  </span><span class="c1"># Failing here would result in failure</span>
<span class="w">  </span>begin_fail_zone
<span class="w">  </span><span class="nb">false</span><span class="w"> </span>is<span class="w"> </span>ok<span class="w"> </span>here
<span class="o">)</span>
</pre></div>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh end_fail_zone">
<span class="sig-name descname"><span class="pre">end_fail_zone</span></span><a class="headerlink" href="#function-testlib.bsh end_fail_zone" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>End a fail zone</p>
<p>While not common, it might be possible to have a test that is likely to fail in one of many places; for this reason a fail zone can be turned off, before being turned on again.</p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>begin_required_fail_test<span class="w"> </span><span class="s2">&quot;Some test&quot;</span>
<span class="o">(</span>
<span class="w">  </span>setup_test
<span class="w">  </span><span class="nb">true</span><span class="w"> </span>something

<span class="w">  </span>begin_fail_zone
<span class="w">  </span>maybe_false
<span class="w">  </span>end_fail_zone

<span class="w">  </span><span class="nb">true</span><span class="w"> </span>again

<span class="w">  </span>begin_fail_zone
<span class="w">  </span>false_if_other_was_not
<span class="w">  </span><span class="c1"># end_fail_zone # not required at the end of the test, but won&#39;t hurt</span>
<span class="o">)</span>
end_test
</pre></div>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh setup_test">
<span class="sig-name descname"><span class="pre">setup_test</span></span><a class="headerlink" href="#function-testlib.bsh setup_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Sets up the test</p>
<p>Once inside the () subshell, typically set -eu needs to be run, then other things such as checking to see if a test should be skipped, etc. need to be done. This is all encapsulated into <a class="reference internal" href="#function-testlib.bsh setup_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup_test</span></code></a>. This is required; without it, <a class="reference internal" href="#function-testlib.bsh end_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_test</span></code></a> will know you forgot to call this and fail.</p>
<p>This is also the second part of creating a skippable test.</p>
<p>You are free to change “set -eu” after <a class="reference internal" href="#function-testlib.bsh setup_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup_test</span></code></a>, should you wish.</p>
<p class="rubric">Usage</p>
<p>Place at the beginning of a test</p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>skip_next_test
begin_test<span class="w"> </span><span class="s2">&quot;Skipping test&quot;</span>
<span class="o">(</span>
<span class="w">  </span>setup_test
<span class="w">  </span><span class="c1">#test code here</span>
<span class="o">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh skip_next_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">skip_next_test</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh end_test">
<span class="sig-name descname"><span class="pre">end_test</span></span><a class="headerlink" href="#function-testlib.bsh end_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>End of a test demarcation</p>
<p class="rubric">Usage</p>
<p>Mark the end of a test. Must be the first command after the test group, or else the return value will not be captured successfully.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh begin_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_test</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh skip_next_test">
<span class="sig-name descname"><span class="pre">skip_next_test</span></span><a class="headerlink" href="#function-testlib.bsh skip_next_test" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Function to indicate the next test should be skipped</p>
<p>This is the first part of creating a skippable test, used in conjunction with <a class="reference internal" href="#function-testlib.bsh setup_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup_test</span></code></a></p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>For<span class="w"> </span>example,<span class="w"> </span>skip<span class="w"> </span><span class="k">if</span><span class="w"> </span>docker<span class="w"> </span><span class="nb">command</span><span class="w"> </span>not<span class="w"> </span>found

<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>docker<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>skip_next_test
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span>begin_test<span class="w"> </span><span class="s2">&quot;My test&quot;</span>
<span class="w">  </span><span class="o">(</span>
<span class="w">    </span>setup_test
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ubuntu:14.04<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>hi<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hi&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">  </span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh setup_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">setup_test</span></code></a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This must be done outside of the test, or else the skip variable will not be set and detected by <a class="reference internal" href="#function-testlib.bsh end_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">end_test</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh track_touched_files">
<span class="sig-name descname"><span class="pre">track_touched_files</span></span><a class="headerlink" href="#function-testlib.bsh track_touched_files" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Start tracking touched files</p>
<p>After running <a class="reference internal" href="#function-testlib.bsh track_touched_files"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">track_touched_files</span></code></a>, any call to <a class="reference internal" href="#function-testlib.bsh ttouch"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">ttouch</span></code></a> will cause that file to be added to the internal list (touched_files). Just prior to the teardown phase, all of these files will be automatically removed for your convenience.</p>
<p><a class="reference internal" href="#function-testlib.bsh ttouch"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">ttouch</span></code></a> should be used in cases where a file cannot be redirected to <span class="target" id="index-20"></span><a class="reference internal" href="#envvar-TESTDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TESTDIR</span></code></a> or <span class="target" id="index-21"></span><a class="reference internal" href="#envvar-TRASHDIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">TRASHDIR</span></code></a></p>
<p class="rubric">Example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>setup<span class="o">()</span>
<span class="o">{</span>
<span class="w">  </span>track_touched_files
<span class="o">}</span>
begin_test<span class="w"> </span>Testing
<span class="o">(</span>
<span class="w">  </span>ttouch<span class="w"> </span>/tmp/hiya
<span class="o">)</span>
end_test
</pre></div>
</div>
<p class="rubric">Usage</p>
<p>Should be called before the <a class="reference internal" href="#function-testlib.bsh begin_test"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">begin_test</span></code></a> block, not inside. Inside a () subshell block will not work. Setup is the logical place to put it.</p>
<p class="rubric">Bugs</p>
<p>Does not work in sh, only <code class="docutils literal notranslate"><span class="pre">bash</span></code>. Uses array, and I didn’t want to make this use a string instead.</p>
<p>Not thread safe. Use a different file for each thread</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh cleanup_touched_files"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">cleanup_touched_files</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh ttouch">
<span class="sig-name descname"><span class="pre">ttouch</span></span><a class="headerlink" href="#function-testlib.bsh ttouch" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Touch function that should behave like the original touch command</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#function-testlib.bsh track_touched_files"><code class="xref bash bash-func docutils literal notranslate"><span class="pre">track_touched_files</span></code></a></p>
</div>
<dl class="bash function">
<dt class="sig sig-object bash" id="function-testlib.bsh cleanup_touched_files">
<span class="sig-name descname"><span class="pre">cleanup_touched_files</span></span><a class="headerlink" href="#function-testlib.bsh cleanup_touched_files" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<p>Delete all the touched files</p>
<p>At the end of the last test, delete all the files in the array</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="test_utils.auto.html" class="btn btn-neutral float-left" title="Test Utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../python/modules.html" class="btn btn-neutral float-right" title="vsi" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Vision Systems, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>