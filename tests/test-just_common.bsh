#!/usr/bin/env bash

. "$(dirname ${BASH_SOURCE[0]})/testlib.sh"
. "$(dirname ${BASH_SOURCE[0]})/test_utils.bsh"

VSI_COMMON_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"
. "${VSI_COMMON_DIR}/linux/just_common.bsh"

begin_test "JUST_VERSION check"
(
  set -eu
  SPOOF_VERSION="${JUST_VERSION}.1"

  message="$(set +xv; source "${VSI_COMMON_DIR}/linux/just_common.bsh" 2>&1 1>/dev/null)"
  [ "${message}" = "" ]

  message="$(set +xv; JUST_VERSION="${SPOOF_VERSION}" source "${VSI_COMMON_DIR}/linux/just_common.bsh" 2>&1 1>/dev/null)"
  [[ "${message}" = WARNING:* ]]
)
end_test

begin_test "_just_commands_from_file"
(
  set -eu

  JUST_HELP_SEPARATOR=':-:'

  # Null case
  [ "$(_just_commands_from_file <(:))" = "" ]

  # Single line
  input='apple)#Red delicious'
  ans='apple :-: Red delicious'
  [ "$(_just_commands_from_file <(echo -n "${input}"))" = "${ans}" ]

  input+=$'\n  cherry) '
  # Another null case

  # Test extra spaces
  input+=$'\napricot) #Ok drupe fruit'
  ans+=$'\napricot :-: Ok drupe fruit'
  input+=$'\navacado)# The first of the evil fruit'
  ans+=$'\navacado :-: The first of the evil fruit'
  input+=$'\n  banana   )  #  Every  monkey\'s    favorite  '
  ans+=$'\nbanana :-: Every  monkey\'s    favorite'
  input+=$'\n#   Bilberry  ) # That Norwegian treat  '
  ans+=$'\nBilberry :-: That Norwegian treat'

  # Test Comment different from target
  input+=$'\n#blackberry) #That\'s a phone, right?'
  input+=$'\nblackberr*)'
  ans+=$'\nblackberry :-: That\'s a phone, right?'

  # This expansion feature should pass through unchanged
  cucurbitaceae=(cucumber sqauch zucchini)
  input+=$'\n# fresh_{cucurbitaceae}) # Fresh'
  input+=$'\nfresh_*)'
  ans+=$'\nfresh_{cucurbitaceae} :-: Fresh'

  # Test multiple target
  input+=$'\nraspberry|strawberry) # Common aggregate fruit  '
  ans+=$'\nraspberry :-: Common aggregate fruit'
  ans+=$'\nstrawberry :-: Common aggregate fruit'

  input+=$'\nboysenberry|\\'
  input+=$'\nmarionberry) \\'
  input+=$'\n # Unnatural cultivars'
  ans+=$'\nboysenberry :-: Unnatural cultivars'
  ans+=$'\nmarionberry :-: Unnatural cultivars'
  # [ "$(_just_commands_from_file <(echo -n "${input}") | od -a -t x1)" = "$(od -a -t x1 <<< "${ans}")" ]
  [ "$(_just_commands_from_file <(echo -n "${input}"))" = "${ans}" ]

)
end_test

begin_test "_just_subcommands_from_array"
(
  set -eu

  [ "$(_just_subcommands_from_array <(:))" = "" ]

  input='pineapple #@# Not an apple'
  [ "$(_just_subcommands_from_array <<< "${input}")" = "" ]

  input='apple_washington #@# Red apple'
  ans='apple'
  [ "$(_just_subcommands_from_array <<< "${input}")" = "${ans}" ]

  input+=$'\napple_fuji #@# Red apple'
  ans+=$'\napple'
  input+=$'\napple_gala #@# Red apple'
  ans+=$'\napple'
  input+=$'\napple_golden_delicious #@# Not a red apple'
  ans+=$'\napple'
  [ "$(_just_subcommands_from_array <<< "${input}")" = "${ans}" ]

  input+=$'\norange #@# An orange orange'
  input+=$'\napple_honey_crisp #@# Also a red apple'
  ans+=$'\napple'
  [ "$(_just_subcommands_from_array <<< "${input}")" = "${ans}" ]

  input+=$'\npepper_bell #@# The evil pepper'
  ans+=$'\npepper'
  input+=$'\npepper_habanero #@# The good pepper'
  ans+=$'\npepper'
  input+=$'\npepper_jalapeño #@# Another good pepper'
  ans+=$'\npepper'
  input+=$'\napple_jazz #@# The musical apple'
  ans+=$'\napple'
  input+=$'\npepper_ghost #@# Bet\'cha can\'t have more than just one'
  ans+=$'\npepper'
  [ "$(_just_subcommands_from_array <<< "${input}")" = "${ans}" ]
)
end_test

begin_test "_just_subtargets_from_array"
(
  set -eu
  help_lines=()

  just_subtargets=()
  _just_subtargets_from_array apple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets
  _just_subtargets_from_array pineapple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets
  _just_subtargets_from_array pepper ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets

  help_lines+=('pineapple #@# Not an apple')
  _just_subtargets_from_array apple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets
  _just_subtargets_from_array pineapple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets
  _just_subtargets_from_array pepper ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets

  help_lines=('apple_washington #@# Red apple')
  _just_subtargets_from_array apple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets washington
  just_subtargets=()
  _just_subtargets_from_array pepper ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets


  help_lines+=('apple_fuji #@# Red apple')
  help_lines+=('apple_gala #@# Red apple')
  help_lines+=('apple_golden_delicious #@# Not a red apple')
  _just_subtargets_from_array apple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets washington fuji gala golden_delicious
  just_subtargets=()
  _just_subtargets_from_array pepper ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets

  help_lines+=('orange #@# An orange orange')
  help_lines+=('apple_honey_crisp #@# Also a red apple')


  help_lines+=('pepper_bell #@# The evil pepper')
  help_lines+=('pepper_habanero #@# The good pepper')
  help_lines+=('pepper_jalapeño #@# Another good pepper')
  help_lines+=('apple_jazz #@# The musical apple')
  help_lines+=($'pepper_ghost #@# Bet\'cha can\'t have more than just one')

  _just_subtargets_from_array apple ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets washington fuji gala golden_delicious honey_crisp jazz
  just_subtargets=()
  _just_subtargets_from_array orange ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets
  _just_subtargets_from_array pepper ${help_lines+"${help_lines[@]}"}
  check_a just_subtargets bell habanero jalapeño ghost
)
end_test

begin_test "just parse helps"
(
  JUST_HELP_SEPARATOR='#@#'
  set -eu

  # Test expansion
  COLORS=(red yellow green gammaray)
  s=$'#test_{COLORS}) # The color is\n'
  s+=$'test_*)'
  _just_parse_helps <(printf "${s}")
  color_ans=('test_red #@# The color is red' \
             'test_yellow #@# The color is yellow' \
             'test_green #@# The color is green' \
             'test_gammaray #@# The color is gammaray')
  check_a parsed_help_a "${color_ans[@]}"

  # Test everything else
  s=$'what) #huh\n'
  s+=$'a|b|c) # test\n'
  s+=$'mix|mix_ed|mixed) # best\n'
  s+=$'mix_ed|mixed) # test\n'
  s+=$'mix|mix_ed) # fest\n'
  s+=$'d|\\\ne) # foo\n'

  ans=('what #@# huh' \
       'a #@# test' \
       'b #@# test' \
       'c #@# test' \
       'mix #@# best' \
       'mix_ed #@# best' \
       'mixed #@# best' \
       'mix_ed #@# test' \
       'mixed #@# test' \
       'mix #@# fest' \
       'mix_ed #@# fest' \
       'd #@# foo' \
       'e #@# foo')

  _just_parse_helps <(printf "${s}")
  check_a parsed_help_a "${ans[@]}"

  s+=$'#test_{COLORS}) # The color is\n'
  s+=$'test_*)\n'
  s+=$'normal) # One more'
  ans+=('normal #@# One more')
  # Ordering gets changed by expansion, no big deal. It's all normal
  ans+=("${color_ans[@]}")
  _just_parse_helps <(printf "${s}")

  declare -p ans
  declare -p parsed_help_a
  check_a parsed_help_a "${ans[@]}"
)
end_test

begin_test "_just_get_plugins"
(
  set -eu

  _just_get_plugins
  check_a JUST_PLUGINS

  echo "testa" > .justplugins
  echo "testb" >> .justplugins
  echo "testc" >> .justplugins

  _just_get_plugins
  check_a JUST_PLUGINS "${TESTDIR}/testa" "${TESTDIR}/testb" "${TESTDIR}/testc"

  JUST_PLUGIN_FILE=test2
  echo "test_1" > test2
  echo "test_2" >> test2
  echo "test_3" >> test2
  _just_get_plugins .
  check_a JUST_PLUGINS "${TESTDIR}/testa"  "${TESTDIR}/testb"  "${TESTDIR}/testc" \
                       "${TESTDIR}/test_1" "${TESTDIR}/test_2" "${TESTDIR}/test_3"

)
end_test
