#!/usr/bin/env bash

if [ -z ${VSI_COMMON_DIR+set} ]; then
  VSI_COMMON_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"
fi

source "${VSI_COMMON_DIR}/tests/testlib.bsh"
source "${TESTLIB_DIR}/test_utils.bsh"
source "${VSI_COMMON_DIR}/linux/bash_utils.bsh"
source "${VSI_COMMON_DIR}/linux/string_tools.bsh"
source "${VSI_COMMON_DIR}/linux/quotemire"

function clean_trace()
{
  if [ "${BASH_VERSINFO[0]}${BASH_VERSINFO[1]}" -lt "41" ]; then
    set +xv
  fi
}

begin_test "Print stack trace"
(
  setup_test

  function foo()
  {
    bar
  }
  function bar()
  {
    print_bash_stack
  }

  nl=$'\n'

  tb="$(clean_trace; bar 2>&1)"
  assert_starts_with "${tb}" "Call stack"
  assert_regex_eq "${tb}" "${nl}"'1\. bar\(\) *:[0-9]* *'"$(regex_escape "${BASH_SOURCE[0]}")"

  tb="$(clean_trace; set +xv; foo 2>&1)"
  assert_starts_with "${tb}" "Call stack"
  assert_regex_eq "${tb}" "${nl}"'1\. bar\(\) *:[0-9]* *'"$(regex_escape "${BASH_SOURCE[0]}")"
  assert_regex_eq "${tb}" "${nl}"'2\. foo\(\) *:[0-9]* *'"$(regex_escape "${BASH_SOURCE[0]}")"
)
end_test

if ! command -v screen >& /dev/null; then
  skip_next_test
elif [[ "${OSTYPE-}" = darwin* ]] && [ "$(sw_vers -buildVersion)" = "Darling" ]; then
  # Screen doesn't work in darling
  skip_next_test
fi

begin_test "RC File insertion"
(
  setup_test

  session="${TRASHDIR////}"
  screen -c /dev/null -dmS "${session}" bash

  # Macos compatibility, needs a literal newline
  nl=$'\n'

  stdin="$(quotemire "set -xv; touch" \
                       "${TESTDIR}/bar")${nl}"

  # Got too complicated, use quotemire
  cmd="$(quotemire "source '${VSI_COMMON_DIR}/linux/bash_utils.bsh'; run_bash_rc_file" \
                     "set -xv; touch" \
                       "${TESTDIR}/foo")${nl}"

  screen -S "${session}" -p 0 -X stuff "${cmd}"
  screen -S "${session}" -p 0 -X stuff "${stdin}"

  for ((i=0; i < 500; i++ )); do
    if [ -e "${TESTDIR}/bar" ]; then
      break
    fi
    sleep 0.01
  done
  screen -S "${session}" -X quit

  [ -f "${TESTDIR}/foo" ]
  [ -f "${TESTDIR}/bar" ]
)
end_test

function teardown()
{
  # cleanup in case test fails
  command -v screen >& /dev/null && screen -S "${TRASHDIR////}" -X quit >& /dev/null || :
}
