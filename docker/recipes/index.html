<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Docker recipes &mdash; VSI Common 0.2.2+1dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Get Pipenv" href="get-pipenv.auto.html" />
    <link rel="prev" title="vsi.windows package" href="../../python/vsi.windows.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VSI Common
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../just/index.html">J.U.S.T. Useful Simple Tasking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests/index.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/modules.html">vsi</a></li>
<li class="toctree-l1"><a class="reference internal" href="get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="pip-8210.auto.html">pip 8210</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Docker recipes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-to-use">How to use</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-this-is-not">What this is not</a></li>
<li class="toctree-l2"><a class="reference internal" href="#recipes">Recipes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vsi-common">VSI Common</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tini">tini</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gosu">gosu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ep-envplate">ep - envplate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jq-json-processor">jq - JSON Processor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ninja">ninja</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker">Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-compose">Docker compose</a></li>
<li class="toctree-l3"><a class="reference internal" href="#git-large-file-support">git Large File Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmake">CMake</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pipenv">Pipenv</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rocky-repos">Rocky Repos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cuda">CUDA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-args">Build Args</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cuda-gl">CUDA GL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amanda-debian-packages">Amanda debian packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#one-true-awk">One True Awk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conda-s-python">Conda’s python</a></li>
<li class="toctree-l3"><a class="reference internal" href="#proj-data">PROJ-data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#j-u-s-t">J.U.S.T.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-locally">Testing locally</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../style.html">Contributing Style Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VSI Common</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Docker recipes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docker/recipes/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="get-pipenv.auto.html">Get Pipenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="pip-8210.auto.html">pip 8210</a></li>
</ul>
</div>
<section id="docker-recipes">
<h1>Docker recipes<a class="headerlink" href="#docker-recipes" title="Permalink to this heading"></a></h1>
<a class="reference external image-reference" href="https://circleci.com/gh/VisionSystemsInc/docker_recipes"><img alt="CirclCI" src="https://circleci.com/gh/VisionSystemsInc/docker_recipes.svg?style=svg" /></a>
<p>A docker recipe is a (usually very small) docker image that is included in a multi-stage build so that you don’t always have to find and repeat that “prefect set of Dockerfile lines to include software XYZ”, such as gosu, tini, etc… They are based heavily on ONBUILD and meant to be used as their own stage.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span>Dockerfile
<span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:tini</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">tini</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:gosu</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">gosu</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span><span class="w"> </span><span class="c">#My real docker image</span>

<span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>stuff<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example

<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>tini<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>gosu<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local

<span class="c"># Universal patch command that all recipes could use</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<section id="how-to-use">
<h2>How to use<a class="headerlink" href="#how-to-use" title="Permalink to this heading"></a></h2>
<p>The recipes can be used directly from dockerhub. It is also possible to include this repo as a submodule in the greater project, and building directly from the dockerfiles.</p>
<p>Many recipes have build arguments. This allows you to control what versions (usually) the recipe will use. This means the build arg needs to be set when the docker build command is issued, unless you want to use the default value.</p>
<ul class="simple">
<li><p>When using <code class="docutils literal notranslate"><span class="pre">docker</span></code>, this is done by <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span> <span class="pre">--build-arg</span> <span class="pre">key=val</span> <span class="pre">...</span></code>.</p></li>
<li><p>With <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span></code> this can be done by <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">buildx</span> <span class="pre">bake</span> <span class="pre">--set</span> <span class="pre">*.args.key=val</span> <span class="pre">...</span></code>.</p>
<ul>
<li><p>But it is better to add it to the <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> file instead.</p></li>
</ul>
</li>
<li><p>What you cannot do is add a build <code class="docutils literal notranslate"><span class="pre">ARG</span></code> to the global section of the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> and expect that default value to affect the recipe, that is not how they work.</p></li>
</ul>
</section>
<section id="what-this-is-not">
<h2>What this is not<a class="headerlink" href="#what-this-is-not" title="Permalink to this heading"></a></h2>
<p>A universal way to “INCLUDE” or “IMPORT” one Dockerfile into another. It only works under a certain set of circumstances</p>
<ul class="simple">
<li><p>Your file recipe output can be <em>easily</em> added using the Dockerfile <code class="docutils literal notranslate"><span class="pre">ADD</span></code> command</p></li>
<li><p>You are ok with customizing the version number using build args to override the default value</p></li>
<li><p>When your code is relatively portable. A python virtualenv is not, unfortunately. Go (when compiled statically) is almost always ultra portable.</p>
<ul>
<li><p>musl versions have to be done separately. For example: tini (glibc) and tini-musl (musl)</p></li>
</ul>
</li>
</ul>
</section>
<section id="recipes">
<h2>Recipes<a class="headerlink" href="#recipes" title="Permalink to this heading"></a></h2>
<section id="vsi-common">
<h3>VSI Common<a class="headerlink" href="#vsi-common" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>VSI Common</p></td>
</tr>
<tr class="row-even"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/vsi</span></code></p></td>
</tr>
</tbody>
</table>
<p>Some VSI Common functions are needed in the container, this provides a mechanism to copy them in, even if the <code class="file docutils literal notranslate"><span class="pre">just</span></code> executable is used.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:vsi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">vsi</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>vsi<span class="w"> </span>/vsi<span class="w"> </span>/vsi
</pre></div>
</div>
</section>
<section id="tini">
<h3>tini<a class="headerlink" href="#tini" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>tini</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">TINI_VERSION</span></code> - Version of tini to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>Tini is a process reaper, and should be used in dockers that spawn new processes</p>
<p>There is a similar version for alpine: tini-musl</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:tini</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">tini</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>tini<span class="w"> </span>COPY<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="gosu">
<h3>gosu<a class="headerlink" href="#gosu" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>gosu</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GOSU_VERSION</span></code> - Version of gosu to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>sudo written with docker automation in mind (no passwords ever)</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:gosu</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">gosu</span>
<span class="c"># The following line will NOT work. docker bug?</span>
<span class="c"># RUN chmod u+s /usr/local/bin/gosu</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>gosu<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
<span class="c"># Optionally add SUID bit so an unprivileged user can run as root (like sudo)</span>
<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>u+s<span class="w"> </span>/usr/local/bin/gosu
</pre></div>
</div>
</section>
<section id="ep-envplate">
<h3>ep - envplate<a class="headerlink" href="#ep-envplate" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>ep</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EP_VERSION</span></code> - Version of ep to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>ep is a simple way to apply bourne shell style variable name substitution to any generic configuration file for applications that do not support environment variable name substitution</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:ep</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">ep</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>ep<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="jq-json-processor">
<h3>jq - JSON Processor<a class="headerlink" href="#jq-json-processor" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>jq</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">JQ_VERSION</span></code> - Version of jq to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>jq is a lightweight and flexible command-line JSON processor</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:jq</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">jq</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>jq<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="ninja">
<h3>ninja<a class="headerlink" href="#ninja" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>ninja</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NINJA_VERSION</span></code> - Version of Ninja to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>Ninja is generally a better/faster alternative to GNU Make.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:ninja</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">ninja</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>ninja<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="docker">
<h3>Docker<a class="headerlink" href="#docker" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Docker</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">DOCKER_VERSION</span></code> - Version of docker to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code> including <code class="docutils literal notranslate"><span class="pre">docker</span></code> and several other files.</p></td>
</tr>
</tbody>
</table>
<p>Docker is a tool for running container applications</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:docker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">docker</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>docker<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="docker-compose">
<h3>Docker compose<a class="headerlink" href="#docker-compose" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>docker compose</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">DOCKER_COMPOSE_VERSION</span></code> - Version of docker compose to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>Tool for running simple docker orchestration, giving an organized way to run one or more dockers.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:docker-compose</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">docker-compose</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>docker-compose<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
<p>This recipe will work glibc and musl for docker compose version 2.0.0 and newer. Version 1 would need to use docker compose provided images for alpine: <code class="docutils literal notranslate"><span class="pre">docker/compose:alpine-${DOCKER_COMPOSE_VERSION}</span></code></p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">ARG</span><span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_COMPOSE_VERSION</span><span class="p">-1.26.2</span><span class="si">}</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">docker/compose:alpine-${DOCKER_COMPOSE_VERSION}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">docker-compose</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">alpine:3.11</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>git<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>docker-compose<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="git-large-file-support">
<h3>git Large File Support<a class="headerlink" href="#git-large-file-support" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>git lfs</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GIT_LFS_VERSION</span></code> - Version of git-lfs to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>git-lfs gives git the ability to handle large files gracefully.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:git-lfs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">git-lfs</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>git-lfs<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
...
<span class="c"># Only needs to be run once for all recipes</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
</section>
<section id="cmake">
<h3>CMake<a class="headerlink" href="#cmake" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>CMake</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CMAKE_VERSION</span></code> - Version of CMake to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>CMake is a cross-platform family of tools designed to build, test and package software</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:cmake</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">cmake</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>cmake<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="pipenv">
<h3>Pipenv<a class="headerlink" href="#pipenv" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Pipenv</p></td>
</tr>
<tr class="row-even"><td><p>Env Var</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PIPENV_VERSION</span></code> - Version of pipenv source to download</p></td>
</tr>
<tr class="row-odd"><td><p>Env Var</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PIPENV_VIRTUALENV</span></code> - The location of the pipenv virtualenv</p></td>
</tr>
<tr class="row-even"><td><p>Env Var</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PIPENV_PYTHON</span></code> - Optional default python executable to use. This is useful when combined with the “Conda’s Python” recipe</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>Pipenv is the new way to manage python requirements (within a virtualenv) on project.</p>
<p>Since this is setting up a virtualenv, you can’t just move <code class="docutils literal notranslate"><span class="pre">/usr/local/pipenv</span></code> to anywhere in the destination image, it must created in the correct location. If this needs to be changed, adjust the <code class="docutils literal notranslate"><span class="pre">PIPENV_VIRTUALENV</span></code> arg.</p>
<p>The default python will be used when <a class="reference internal" href="get-pipenv.auto.html#get-pipenv"><span class="std std-ref">Get Pipenv</span></a> is called. The default python is used for all other pipenv calls. In order to customize the default python interpreter used, set the <code class="docutils literal notranslate"><span class="pre">PYTHON</span></code> build arg, or else you will need to use the <code class="docutils literal notranslate"><span class="pre">--python/--two/--three</span></code> flags when calling <code class="docutils literal notranslate"><span class="pre">pipenv</span></code>.</p>
<p>This recipe is a little different from other recipes in that it’s just a script to set up the virtualenv in the destination image. Virtualenvs have to be done this way due to their non-portable nature; this is especially true because this virtualenv creates other virtutalenvs that need to point to the system python.</p>
<p>A script called <code class="docutils literal notranslate"><span class="pre">fake_package</span></code> is added to the pipenv virtualenv, this script is useful for creating fake editable packages, that will be mounted in at run time.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:pipenv</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">pipenv</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>pipenv<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
...
<span class="c"># Only needs to be run once for all recipes</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
</section>
<section id="rocky-repos">
<h3>Rocky Repos<a class="headerlink" href="#rocky-repos" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Rocky Linux Repos</p></td>
</tr>
<tr class="row-even"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>Rocky Linux is a subscription free RHEL alternative. Often adding Rocky packages to a UBI image is useful.</p>
<p>Since this is installs specific packages based on the base image, you can’t just move <code class="docutils literal notranslate"><span class="pre">/usr/local/pipenv</span></code> to anywhere in the destination image, it is a script that must run in the image.</p>
<p>This recipe is a little different from other recipes in that it’s just a script to install repos (and corresponding gpg keys).</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:rocky</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">rocky</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">redhat/ubi8</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>rocky<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
<span class="c"># Only needs to be run once for all recipes</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="k">RUN</span><span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--enablerepo<span class="o">=</span>rocky-appstream<span class="w"> </span>telnet<span class="w"> </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
...
</pre></div>
</div>
</section>
<section id="cuda">
<h3>CUDA<a class="headerlink" href="#cuda" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>CUDA</p></td>
</tr>
<tr class="row-even"><td><p>Special Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CUDA_REPO_REF</span></code> - The ref of the CUDA container repo parsed. Set via exporting the environment variable <code class="docutils literal notranslate"><span class="pre">DOCKER_RECIPE_CUDA_REPO_REF</span></code>. Default: <code class="docutils literal notranslate"><span class="pre">81682547e12c8807ebc5fa61ff4576510925a324</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CUDA_VERSION</span></code> - Version of CUDA to install (e.g. <code class="docutils literal notranslate"><span class="pre">10.2</span></code> or <code class="docutils literal notranslate"><span class="pre">11.0.7</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CUDNN_VERSION</span></code> - Optional: Version of CUDNN to install. (e.g. <code class="docutils literal notranslate"><span class="pre">7</span></code> or <code class="docutils literal notranslate"><span class="pre">8</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CUDA_RECIPE_TARGET</span></code> - Optional: Specifies how much of the CUDA stack to install (explained below). Default: <code class="docutils literal notranslate"><span class="pre">runtime</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Environment Variable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> - Required: Sets which nvidia devices are visible in the container. Set to: <code class="docutils literal notranslate"><span class="pre">all</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Environment Variable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_DRIVER_CAPABILITIES</span></code> - Optional: Which device capabilities are enabled in the container. Default: <code class="docutils literal notranslate"><span class="pre">compute,utility</span></code>, which, if unset, is the default assumed by the runtime.</p></td>
</tr>
<tr class="row-even"><td><p>Environment Variable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_REQUIRE_*</span></code> - Optional: Sets test conditions to prevent running on incompatible systems</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Minimum Dockerfile frontend:</p></td>
<td><p>docker/dockerfile:1.3-labs or docker/dockerfile:1.4</p></td>
</tr>
</tbody>
</table>
<p>While starting from a base image with CUDA already setup for docker is ideal, when we have to be based on a specific image (e.g. hardened images), this becomes impossible or impractical. Instead we need to start with a particular image and add CUDA support to it.</p>
<p>Currently, only RHEL and Ubuntu based images are supported (not Fedora or Debian).</p>
<p>There are many steps to setting up CUDA in an image:</p>
<ul class="simple">
<li><p>Setting up the CUDA repo and GPG key</p></li>
<li><p>Installing the right packages, so that we limit the amount of bloat to the image</p></li>
<li><p>Setting certain environment variables at container create time</p></li>
<li><p>Setting various environment variables at container run time</p></li>
</ul>
<p>This recipe will attempt to do all of these things in as few steps as possible, except setting environment variables at container create time which you will have to do manually.</p>
<section id="environment-variables">
<h4>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this heading"></a></h4>
<p>Because of how the nvidia runtime operates, it needs certain variables set at container create time. Some ways this can be accomplished include:</p>
<ul class="simple">
<li><p>Adding an <code class="docutils literal notranslate"><span class="pre">ENV</span></code> to the Dockerfile</p></li>
<li><p>Adding to the <code class="docutils literal notranslate"><span class="pre">environment:</span></code> section in <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code></p></li>
<li><p>Adding the <code class="docutils literal notranslate"><span class="pre">-e</span></code> flag to the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> call</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> must be set, or else the nvidia runtime will not activate, and you will have no GPU support. It’s suggested to set <code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> to <code class="docutils literal notranslate"><span class="pre">all</span></code> and allow for an environment variable on the host (i.e. in <code class="docutils literal notranslate"><span class="pre">local.env</span></code>) to override the value to use specific GPUs as needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">NVIDIA_DRIVER_CAPABILITIES</span></code> is usually set, but it is optional because unset and set to null means the <code class="docutils literal notranslate"><span class="pre">compute,utility</span></code> capabilities are passed in. This is enough for most CUDA capabilities.</p>
<p>You can optionally add <code class="docutils literal notranslate"><span class="pre">NVIDIA_REQUIRE_*</span></code> environment variables (Commonly: <code class="docutils literal notranslate"><span class="pre">NVIDIA_REQUIRE_CUDA</span></code>) as a set of rules to declare what version of cuda, drivers, architecture, and brand. You only need to set this if you want docker to refuse to run when constraints are not met (e.g. driver doesn’t support CUDA 11.6). See the <a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html#constraints">documentation</a> and an <a class="reference external" href="https://gitlab.com/nvidia/container-images/cuda/-/blob/5bc8c5483115b8e9c68d4f1280acb8d56196d681/dist/11.6.2/ubi8/base/Dockerfile#L6">example</a> for more information.</p>
</section>
<section id="build-args">
<h4>Build Args<a class="headerlink" href="#build-args" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">CUDA_VERSION</span></code>/<code class="docutils literal notranslate"><span class="pre">CUDNN_VERSION</span></code> build args must be limited to the versions of CUDA in the <a class="reference external" href="https://developer.download.nvidia.com/compute/cuda/repos/">nvidia package repos</a>. Attempting combinations of OS versions and CUDA versions not in the nvidia <a class="reference external" href="https://gitlab.com/nvidia/container-images/cuda/-/tree/master/dist">codebase</a> will probably fail because those versions of CUDA most likely do not exist in the nvidia package repos. Currently the end-of-life directory is not supported.</p>
<p><code class="docutils literal notranslate"><span class="pre">CUDA_RECIPE_TARGET</span></code> is used to specify how much of the CUDA stack to install (devel vs runtime):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">runtime</span></code>: Only installs the runtime packages for CUDA</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">devel</span></code>: Installs both the runtime and development packages for CUDA</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">devel-only</span></code>: Only installs the devel packages. This is intended to be used on an image that already has the CUDA runtime installed.</p></li>
</ul>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># syntax=docker/dockerfile:1.4</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:cuda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">cuda</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">redhat/ubi8</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>cuda<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
<span class="c"># Only needs to be run once for all recipes</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="c"># Required for this recipe</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">NVIDIA_VISIBLE_DEVICES</span><span class="o">=</span>all
<span class="c"># NVIDIA_DRIVER_CAPABILITIES is optional, but not setting it results in compute,utility</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">NVIDIA_DRIVER_CAPABILITIES</span><span class="o">=</span>compute,utility

<span class="c"># Source this file when building packages from source in docker build.</span>
<span class="c"># It loads all the nvidia environment variables</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/usr/local/share/just/user_run_patch/10_load_cuda_env<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cmake<span class="w"> </span>.<span class="w"> </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
...
</pre></div>
</div>
</section>
</section>
<section id="cuda-gl">
<h3>CUDA GL<a class="headerlink" href="#cuda-gl" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>CUDA GL</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CUDA_RECIPE_TARGET</span></code> - Specifies how much of the CUDA stack to install (explained further above in the CUDA recipe). Default: <code class="docutils literal notranslate"><span class="pre">runtime</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LIBGLVND_VERSION</span></code> - The version of the GLVND used. Default: <code class="docutils literal notranslate"><span class="pre">v1.2.0</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Environment Variable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_DRIVER_CAPABILITIES</span></code> - For OpenGL offscreen rendering, you at least need <cite>graphics,compute,utility</cite></p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Minimum Dockerfile frontend:</p></td>
<td><p>docker/dockerfile:1.3-labs or docker/dockerfile:1.4</p></td>
</tr>
</tbody>
</table>
<p>Similar to the CUDA recipe, <code class="docutils literal notranslate"><span class="pre">CUDA_RECIPE_TARGET</span></code> tells the recipe whether to install runtime or development dependencies, although <code class="docutils literal notranslate"><span class="pre">devel-only</span></code> installs both runtime and devel packages, due to how the recipe is structured.</p>
<p><code class="docutils literal notranslate"><span class="pre">LIBGLVND_VERSION</span></code> sets the version of <a class="reference external" href="https://github.com/NVIDIA/libglvnd.git">glvnd repo</a> that is compiled and used.</p>
<p>You will need to set the environment variable <code class="docutils literal notranslate"><span class="pre">NVIDIA_DRIVER_CAPABILITIES</span></code> to allow graphics capabilities which most GL applications will need.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># syntax=docker/dockerfile:1.4</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:cudagl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">cudagl</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">redhat/ubi8</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>cudagl<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
<span class="c"># Only needs to be run once for all recipes</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob<span class="p">;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>patch<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/share/just/container_build_patch/*<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">NVIDIA_DRIVER_CAPABILITIES</span><span class="o">=</span>graphics,compute,utility
...
</pre></div>
</div>
</section>
<section id="amanda-debian-packages">
<h3>Amanda debian packages<a class="headerlink" href="#amanda-debian-packages" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Amanda</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AMANDA_VERSION</span></code> - Branch name to build off of (can be a SHA)</p></td>
</tr>
<tr class="row-odd"><td><p>Output files</p></td>
<td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/amanda-backup-client_${AMANDA_VERSION}-1Debian82_amd64.deb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/amanda-backup-server{AMANDA_VERSION}-1Debian82_amd64.deb</span></code></p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Complies Debian packages for the tape backup software Amanda</p>
</section>
<section id="one-true-awk">
<h3>One True Awk<a class="headerlink" href="#one-true-awk" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>One True Awk</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ONETRUEAWK_VERSION</span></code> - Version of one true awk to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="https://github.com/onetrueawk/awk">https://github.com/onetrueawk/awk</a> is a severly limited version awk that some primative operating systems use. This recipe will help in testing against that version.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:onetrueawk</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">onetrueawk</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">debian:9</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>onetrueawk<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="conda-s-python">
<h3>Conda’s python<a class="headerlink" href="#conda-s-python" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Python</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">USE_MINICONDA</span></code> - Set to <code class="docutils literal notranslate"><span class="pre">1</span></code> to use miniconda instead of miniforge</p></td>
</tr>
<tr class="row-odd"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PYTHON_VERSION</span></code> - Version of python to download</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PYTHON_INSTALL_DIR</span></code> - Location where python will be installed. While you can copy this directory to another docker image, care should be taken as to not change the final absolute path, as python will not be happy about that (e.g. tk/tcl paths will be broken).</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>This is not a recipe for installing anaconda or miniforge, rather it internally uses miniforge to install a “not” conda python environment. This python will still bare the markings of Anaconda, but does not have all the conda modifications, and works as a normal and extremely portable version of python for glibc linux.</p>
<p>See <a class="reference external" href="https://anaconda.org/conda-forge/python/files">https://anaconda.org/conda-forge/python/files</a> (for miniforge)/ <a class="reference external" href="https://anaconda.org/anaconda/python/files">https://anaconda.org/anaconda/python/files</a> (for miniconda) for values of <code class="docutils literal notranslate"><span class="pre">PYTHON_VERSION</span></code></p>
<p>This is the easiest way to install an arbitrary version of python on an arbitrary linux distro.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:conda-python</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">python</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:16.04</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>python<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
<section id="proj-data">
<h3>PROJ-data<a class="headerlink" href="#proj-data" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>PROJ-data</p></td>
</tr>
<tr class="row-even"><td><p>Build Args</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PROJ_DATA_VERSION</span></code> - Version of proj-data to download</p></td>
</tr>
<tr class="row-odd"><td><p>Output dir</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></p></td>
</tr>
</tbody>
</table>
<p>This is a recipe for installing <a class="reference external" href="https://github.com/OSGeo/PROJ-data">PROJ-data</a>, a very large (over 500MB) plugin for the <a class="reference external" href="https://github.com/OSGeo/PROJ">PROJ</a> package. PROJ-data contains a variety of datum grid files necessary for horizontal and vertical coordinate transformations.</p>
<p>PROJ-data files are fully optional, and only downloaded and installed <code class="docutils literal notranslate"><span class="pre">PROJ_DATA_VERSION</span></code> is set.</p>
<p>Users may alternatively make use of <a class="reference external" href="https://proj.org/usage/network.html">remotely hosted PROJ-data</a> to avoid installation of this large package.</p>
<p class="rubric">Example</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">vsiri/recipe:proj-data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">proj-data</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:16.04</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>vim<span class="w">  </span>#<span class="w"> </span>This<span class="w"> </span>line<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>an<span class="w"> </span>example
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>proj-data<span class="w"> </span>/usr/local<span class="w"> </span>/usr/local
</pre></div>
</div>
</section>
</section>
<section id="j-u-s-t">
<h2>J.U.S.T.<a class="headerlink" href="#j-u-s-t" title="Permalink to this heading"></a></h2>
<p>To define the “build recipes” target, add this to your <code class="docutils literal notranslate"><span class="pre">Justfile</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VSI_COMMON_DIR</span><span class="si">}</span><span class="s2">/linux/just_files/just_docker_functions.bsh&quot;</span>
</pre></div>
</div>
<p>And add <code class="docutils literal notranslate"><span class="pre">justify</span> <span class="pre">build</span> <span class="pre">recipes</span></code> to any Justfile target that is responsible for building docker images.</p>
</section>
<section id="testing-locally">
<h2>Testing locally<a class="headerlink" href="#testing-locally" title="Permalink to this heading"></a></h2>
<p>To run recipe tests locally, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>just<span class="w"> </span>build<span class="w"> </span>recipes<span class="w"> </span>--builder<span class="o">=</span>default<span class="w">      </span><span class="c1"># --builder is usually not needed</span>
just<span class="w"> </span>build<span class="w"> </span>recipe-tests<span class="w"> </span>--builder<span class="o">=</span>default<span class="w"> </span><span class="c1"># --builder is usually not needed</span>
just<span class="w"> </span><span class="nb">test</span><span class="w"> </span>recipe
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../python/vsi.windows.html" class="btn btn-neutral float-left" title="vsi.windows package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="get-pipenv.auto.html" class="btn btn-neutral float-right" title="Get Pipenv" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Vision Systems, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>